åœ¨é«˜å¹¶å‘çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒgRPC é•¿è¿æ¥çš„å¥åº·æ£€æŸ¥å’Œæ–­çº¿æ£€æµ‹è‡³å…³é‡è¦ã€‚
æœ¬æ–‡è¯¦ç»†ä»‹ç» gRPC Keepalive çš„åŸç†ã€å¸¸è§é…ç½®ï¼Œä»¥åŠå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æœ€ä½³å®è·µã€‚

ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ Keepalive

é»˜è®¤æƒ…å†µä¸‹ï¼ŒgRPC çš„é•¿è¿æ¥æ˜¯ æƒ°æ€§æ£€æµ‹ çš„ï¼š

å®¢æˆ·ç«¯æ–­å¼€æˆ–ç½‘ç»œä¸­æ–­åï¼ŒæœåŠ¡ç«¯å¯èƒ½ä»è®¤ä¸ºè¿æ¥â€œæ´»ç€â€ï¼›

è¿™ç§â€œåƒµå°¸è¿æ¥â€ä¼šå¯¼è‡´æµå¼ RPC é˜»å¡ã€èµ„æºæµªè´¹ï¼›

æµå¼ RPC æˆ–å¿ƒè·³æ•æ„Ÿåœºæ™¯ï¼Œéœ€è¦ä¸»åŠ¨æ£€æµ‹è¿æ¥çŠ¶æ€ã€‚

è¿æ¥æ–­å¼€æ—¶ï¼Œæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ stream éƒ½ä¼šæŠ¥é”™ï¼ˆä¾‹å¦‚ï¼šrpc error: code = Unavailable desc = transport is closingï¼‰ï¼› ä½†ï¼é»˜è®¤æƒ…å†µä¸‹ gRPC ä¸ä¼šä¸»åŠ¨æ£€æµ‹å¯¹ç«¯æ˜¯å¦è¿˜æ´»ç€ã€‚

è¿æ¥æ–­äº†ï¼Œä½†ä¸ºä»€ä¹ˆå®ƒâ€œä¸ç«‹åˆ»æŠ¥é”™â€ï¼Ÿ

æˆ‘ä»¬æ¥è¯¦ç»†è®²æ¸…æ¥šï¼š

ğŸ§© ä¸€ã€å…ˆçœ‹åº•å±‚æœºåˆ¶ï¼šgRPC å»ºç«‹åœ¨ HTTP/2 ä¹‹ä¸Š

gRPC æœ¬è´¨ä¸Šå¤ç”¨äº†ä¸€ä¸ª HTTP/2 é•¿è¿æ¥ï¼›

è¿æ¥æ–­å¼€è¦ä¾èµ–åº•å±‚ TCP æ¥æ£€æµ‹ï¼›

ä½† TCP æœ¬èº«æ²¡æœ‰ä¸»åŠ¨æ¢æµ‹å¯¹ç«¯æ˜¯å¦è¿˜æ´»ç€ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

å¦‚æœä½ çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯åï¼Œç½‘ç»œçº¿è·¯â€œé™é»˜ä¸­æ–­â€ï¼ˆä¾‹å¦‚ Wi-Fi åˆ‡æ–­ã€NAT è¶…æ—¶ã€VPN æ‰çº¿ä½†æ²¡æœ‰å‘é€ TCP FIN/RSTï¼‰ï¼ŒTCP ä¸ä¼šç«‹åˆ»æŠ¥é”™ï¼ŒgRPC ä¹Ÿå°±â€œæ„Ÿå—ä¸åˆ°â€æ–­å¼€ã€‚

ğŸ•’ äºŒã€åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ gRPC æ‰ä¼šæŠ¥é”™ï¼Ÿ
âœ… æƒ…å†µ 1ï¼šä¸‹ä¸€æ¬¡â€œè¯»/å†™â€å‘ç”Ÿæ—¶

å½“ä½ çš„ stream åœ¨å‘é€æˆ–æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œä¸€æ—¦ TCP å±‚å°è¯•è¯»å†™å¤±è´¥ï¼ˆæ¯”å¦‚æ”¶ä¸åˆ° ACKã€å†™å¤±è´¥ï¼‰ï¼ŒgRPC ä¼šç«‹åˆ»è¿”å›ï¼š

rpc error: code = Unavailable desc = transport is closing


ğŸ‘‰ æ‰€ä»¥ï¼š
å¦‚æœä½ çš„ stream æ²¡æœ‰åœ¨å‘æ¶ˆæ¯ã€ä¹Ÿæ²¡æœ‰åœ¨è¯»æ¶ˆæ¯ï¼Œå°±ä¸ä¼šè§¦å‘ä»»ä½• I/O æ“ä½œï¼ŒgRPC å°±ä¸ä¼šå‘ç°è¿æ¥å·²ç»æŒ‚äº†ã€‚

â†’ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆâ€œçœ‹ä¼¼è¿ç€ä½†å…¶å®å·²ç»æ–­äº†â€ã€‚

âœ… æƒ…å†µ 2ï¼šåº•å±‚ TCP æ£€æµ‹åˆ°è¿æ¥è¶…æ—¶ï¼ˆkeepalive æˆ–ç³»ç»Ÿçº§æ¢æµ‹ï¼‰

åœ¨æ²¡æœ‰åº”ç”¨å±‚ I/O æ—¶ï¼Œåªæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ä¼šè®©è¿æ¥â€œæ„è¯†åˆ°â€å·²ç»æ–­å¼€ï¼š

æ¥æº	æ˜¯å¦é»˜è®¤å¯ç”¨	è¯´æ˜
TCP keepaliveï¼ˆæ“ä½œç³»ç»Ÿçº§ï¼‰	âŒ é»˜è®¤å…³é—­æˆ–è¶…æ—¶éå¸¸é•¿ï¼ˆé€šå¸¸ 2 å°æ—¶ï¼‰	ç³»ç»Ÿå±‚çš„æ¢æµ‹æœºåˆ¶ï¼Œå»¶è¿Ÿå¤ªé«˜
gRPC keepalive ping	âŒ é»˜è®¤å…³é—­	é€šè¿‡ HTTP/2 PING å¸§ä¸»åŠ¨æ£€æµ‹è¿æ¥æ˜¯å¦è¿˜æ´»ç€
ä¸šåŠ¡å¿ƒè·³æ¶ˆæ¯ï¼ˆåº”ç”¨å±‚ï¼‰	âŒ éœ€è‡ªè¡Œå®ç°	æµä¸­å‘é€å¿ƒè·³åŒ…ç¡®è®¤å¯¹ç«¯æ˜¯å¦å“åº”

æ‰€ä»¥åœ¨é»˜è®¤é…ç½®ä¸‹ï¼Œä½ åªèƒ½åœ¨ä¸‹ä¸€æ¬¡çœŸæ­£çš„ RPC è¯»å†™æ—¶æ‰å‘ç°æ–­çº¿ã€‚

âœ… æƒ…å†µ 3ï¼šæœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥

å¦‚æœï¼š

æœåŠ¡ç«¯å…³é—­è¿›ç¨‹ï¼›

æœåŠ¡ç«¯è°ƒç”¨ grpc.Server.Stop()ï¼›

å®¢æˆ·ç«¯ä¸»åŠ¨ cancel contextï¼›

é‚£ä¹ˆï¼š

æ‰€æœ‰ stream ä¼šè¢«ç«‹å³æ ‡è®°ä¸º Unavailableï¼›

Recv() æˆ– Send() è°ƒç”¨ä¼šè¿”å›é”™è¯¯ã€‚

âš™ï¸ ä¸‰ã€å…¸å‹çš„æ—¶é—´çº¿ä¾‹å­
æ—¶é—´	äº‹ä»¶	gRPC è¡Œä¸º
0s	å®¢æˆ·ç«¯å¯åŠ¨ stream	ä¸€åˆ‡æ­£å¸¸
30s	ç½‘ç»œæ–­å¼€ï¼ˆä½†æœªå‘é€ FIN/RSTï¼‰	TCP ä¸çŸ¥é“è¿æ¥æ–­äº†
60s	å®¢æˆ·ç«¯æ²¡åœ¨å‘/æ”¶æ¶ˆæ¯	æ²¡æœ‰ I/Oï¼ŒgRPC ä¸æŠ¥é”™
300s	å®¢æˆ·ç«¯å°è¯•å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯	å†™å¤±è´¥ â†’ æŠ¥é”™ Unavailable
600s	æ²¡æœ‰ Keepaliveï¼Œä¾ç„¶æŒ‚ç€	å®¢æˆ·ç«¯ä»¥ä¸ºè¿˜è¿ç€

è§£å†³æ–¹æ¡ˆå°±æ˜¯ gRPC Keepaliveï¼š

æœåŠ¡ç«¯è‡ªå‘ pingï¼šå®šæœŸæ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦åœ¨çº¿ã€‚

å®¢æˆ·ç«¯ä¿æ´» pingï¼šåœ¨ç©ºé—²æ—¶ä¿æŒå¿ƒè·³ã€‚

é™åˆ¶å®¢æˆ·ç«¯ ping é¢‘ç‡ï¼šé˜²æ­¢æ»¥ç”¨ã€‚

è§£å†³æ–¹æ¡ˆï¼š
å¼€å¯keep alive

äºŒã€æœåŠ¡ç«¯ Keepalive é…ç½®

gRPC æœåŠ¡ç«¯çš„ Keepalive é…ç½®åˆ†ä¸ºä¸¤ç±»ï¼š

ServerParametersï¼šæœåŠ¡ç«¯è‡ªå‘ ping çš„è¡Œä¸º

EnforcementPolicyï¼šé™åˆ¶å®¢æˆ·ç«¯ ping çš„é¢‘ç‡

import (
	"time"
	"google.golang.org/grpc"
	"google.golang.org/grpc/keepalive"
)

func CreateKeepAliveServerOpt(heartbeatInterval, heartbeatTimeout time.Duration) grpc.ServerOption {
	if heartbeatInterval == 0 {
		heartbeatInterval = 10 * time.Second
	}
	if heartbeatTimeout == 0 {
		heartbeatTimeout = 5 * time.Second
	}
	return grpc.KeepaliveParams(keepalive.ServerParameters{
		Time:    heartbeatInterval, // æœåŠ¡ç«¯ç©ºé—²å¤šä¹…å‘é€ ping
		Timeout: heartbeatTimeout,  // ping ç­‰å¾…è¶…æ—¶æ—¶é—´
	})
}

func CreateLimitClientKeepAliveServerOpt(clientHeartbeatMinInterval time.Duration, keepHeartbeatEvenNoStream bool) grpc.ServerOption {
	if clientHeartbeatMinInterval == 0 {
		clientHeartbeatMinInterval = 5 * time.Second
	}
	kaPolicy := keepalive.EnforcementPolicy{
		MinTime:             clientHeartbeatMinInterval, // å®¢æˆ·ç«¯ ping çš„æœ€å°é—´éš”
		PermitWithoutStream: keepHeartbeatEvenNoStream,  // æ˜¯å¦å…è®¸ç©ºé—²æ—¶ ping
	}
	return grpc.KeepaliveEnforcementPolicy(kaPolicy)
}
ğŸ”¹ è§£é‡Š

Timeï¼šæœåŠ¡ç«¯åœ¨å¤šå°‘ç§’å†…æ— æ´»åŠ¨å°± ping å®¢æˆ·ç«¯ã€‚

Timeoutï¼šæœåŠ¡ç«¯ ping åç­‰å¾…å¤šä¹…æœªå›åº”å³æ–­å¼€ã€‚

MinTimeï¼šå®¢æˆ·ç«¯ ping é—´éš”ä¸èƒ½å°äºè¯¥å€¼ï¼Œå¦åˆ™ä¼šè¢«æ–­å¼€ã€‚

PermitWithoutStreamï¼šæ˜¯å¦å…è®¸å®¢æˆ·ç«¯åœ¨æ²¡æœ‰æ´»åŠ¨æµæ—¶ä¹Ÿå‘é€ pingã€‚

ä¸‰ã€å®¢æˆ·ç«¯ Keepalive é…ç½®

å®¢æˆ·ç«¯ Keepalive çš„æ ¸å¿ƒåœ¨äº ClientParametersï¼š

func CreateKeepAliveDialOpt(heartbeatInterval, heartbeatTimeout time.Duration, keepHeartbeatEvenNoStream bool) grpc.DialOption {
	if heartbeatInterval == 0 {
		heartbeatInterval = 10 * time.Second // æ¯ 10s å‘é€ ping
	}
	if heartbeatTimeout == 0 {
		heartbeatTimeout = 5 * time.Second // ping è¶…æ—¶åˆ¤å®šæ–­å¼€
	}
	return grpc.WithKeepaliveParams(keepalive.ClientParameters{
		Time:                heartbeatInterval,
		Timeout:             heartbeatTimeout,
		PermitWithoutStream: keepHeartbeatEvenNoStream,
	})
}
ğŸ”¹ è§£é‡Š

Timeï¼šå®¢æˆ·ç«¯ç©ºé—²å¤šä¹…å‘é€ pingã€‚

Timeoutï¼šæœåŠ¡ç«¯æœªå›åº”å¤šå°‘ç§’åˆ™åˆ¤å®šæ–­å¼€ã€‚

PermitWithoutStreamï¼šæ˜¯å¦å…è®¸åœ¨æ²¡æœ‰æµæ—¶å‘é€ pingã€‚

âš ï¸ æ³¨æ„ï¼šå®¢æˆ·ç«¯å¦‚æœè®¾ç½® PermitWithoutStream=trueï¼Œå¿…é¡»ç¡®ä¿æœåŠ¡ç«¯å…è®¸ç©ºé—² pingï¼Œå¦åˆ™è¿æ¥ä¼šè¢«æ–­å¼€ã€‚

å››ã€ç¤ºä¾‹ï¼šå®¢æˆ·ç«¯ + æœåŠ¡ç«¯é…ç½®
// æœåŠ¡ç«¯
srv := grpc.NewServer(
	CreateKeepAliveServerOpt(30*time.Second, 10*time.Second),
	CreateLimitClientKeepAliveServerOpt(10*time.Second, true),
)

// å®¢æˆ·ç«¯
conn, err := grpc.Dial(
	target,
	CreateKeepAliveDialOpt(10*time.Second, 5*time.Second, true),
)

å«ä¹‰ï¼š

æœåŠ¡ç«¯ï¼š30s å†…æ— æ´»åŠ¨å°± pingï¼Œç­‰å¾… 10s æœªå“åº”æ–­å¼€ï¼›å®¢æˆ·ç«¯ ping é—´éš”è‡³å°‘ 10sã€‚

å®¢æˆ·ç«¯ï¼šå³ä½¿æ²¡æœ‰æµï¼Œæ¯ 10s ping æœåŠ¡ç«¯ï¼Œ5s å†…æ— å“åº”åˆ¤å®šæ–­å¼€ã€‚

è¿™æ ·é…ç½®ï¼Œæµå¼ RPC å¯ä»¥å¿«é€Ÿæ£€æµ‹æ–­çº¿ï¼ŒåŒæ—¶é¿å…å®¢æˆ·ç«¯è¢«è¯¯æ–­å¼€ã€‚

å¯ç”¨ Keepalive åçš„å˜åŒ–

å¦‚æœå¯ç”¨ï¼š

keepalive.ClientParameters{
	Time:    10 * time.Second,
	Timeout: 3 * time.Second,
}


æ—¶é—´çº¿å°±å˜æˆï¼š

æ—¶é—´	äº‹ä»¶	gRPC è¡Œä¸º
0s	å»ºç«‹è¿æ¥	
10s	å‘é€ pingï¼Œæœªæ”¶åˆ° pong	
13s	è¶…æ—¶ â†’ æŠ¥é”™ transport is closing	
14s	stream è‡ªåŠ¨å…³é—­	
15s	å¯è§¦å‘é‡è¿é€»è¾‘	

â†’ gRPC é€šè¿‡ HTTP/2 ping å®ç°äº†ä¸»åŠ¨æ–­çº¿æ£€æµ‹ã€‚

äº”ã€æ€»ç»“

gRPC é»˜è®¤ä¸ä¼šä¸»åŠ¨æ£€æµ‹å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€ï¼ŒKeepalive å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

æœåŠ¡ç«¯ Keepalive åˆ†ä¸ºï¼š

ServerParametersï¼ˆè‡ªå‘ pingï¼‰

EnforcementPolicyï¼ˆé™åˆ¶å®¢æˆ·ç«¯ pingï¼‰

å®¢æˆ·ç«¯ Keepalive é€šè¿‡ ClientParameters é…ç½®ã€‚

PermitWithoutStream å¯ä»¥ä¿è¯ç©ºé—²æ—¶çš„å¿ƒè·³ï¼Œä½†éœ€è¦æœåŠ¡ç«¯é…åˆã€‚

é»˜è®¤å€¼å»ºè®®ï¼š

æœåŠ¡ç«¯ ping æ—¶é—´ï¼š10~30 ç§’

æœåŠ¡ç«¯ ping è¶…æ—¶ï¼š5~10 ç§’

å®¢æˆ·ç«¯æœ€å° ping é—´éš”ï¼š5~10 ç§’

é€šè¿‡åˆç†é…ç½® gRPC Keepaliveï¼Œå¯ä»¥è®©æµå¼ RPC æ›´ç¨³å®šï¼Œå¿«é€Ÿå‘ç°æ–­çº¿ï¼Œå¹¶é¿å…â€œåƒµå°¸è¿æ¥â€ã€‚
