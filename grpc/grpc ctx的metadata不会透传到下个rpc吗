ç»“è®ºï¼šgRPC çš„ metadata ä¼šé€ä¼ ï¼Œä½†ä¸ä¼šè‡ªåŠ¨é€ä¼ ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼š
ğŸ”¹ ä¸€æ¬¡ RPC çš„ metadata ä¸ä¼šè‡ªåŠ¨å¤åˆ¶åˆ°ä¸‹ä¸€æ¬¡ RPC
ğŸ”¹ ä½ å¿…é¡» æ‰‹åŠ¨ä» context å–å‡º metadataï¼Œå†æ”¾å›æ–°çš„ context é‡Œ æ‰èƒ½ç»§ç»­ä¼ é€’ã€‚

âœ”ï¸ ä¸ºä»€ä¹ˆä¸ä¼šè‡ªåŠ¨é€ä¼ ï¼Ÿ

å› ä¸º gRPC çš„è®¾è®¡æ˜¯ï¼š

Metadata å±äºã€Œæœ¬æ¬¡ RPC è°ƒç”¨ã€çš„é™„åŠ ä¿¡æ¯

ä¸æ˜¯å…¨å±€çŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯ context çš„å›ºå®šå­—æ®µ

ä¸ä¼šè‡ªåŠ¨åœ¨ä¸åŒçš„ RPC è°ƒç”¨ä¹‹é—´å…±äº«
å¦‚ä»£ç ï¼š
unc (e *Echo) ProxyEcho(ctx context.Context, req *echo.EchoReq) (*echo.EchoResp, error) {
	m, _ := metadata.FromIncomingContext(ctx)
	fmt.Println(m)
	time.Sleep(time.Second * time.Duration(2))
	return echo.EchoGRPC().BasicEcho(ctx, req)
} è¿™æ ·ä¼šé€ä¼ å—

çŸ­ç»“è®ºï¼šä¸ä¼šé€ä¼ ã€‚

âŒ ä¸ºä»€ä¹ˆä½ çš„å†™æ³•ä¸ä¼šé€ä¼ ï¼Ÿ

ä½ å†™çš„æ˜¯ï¼š

m, _ := metadata.FromIncomingContext(ctx)
fmt.Println(m)
time.Sleep(time.Second * time.Duration(2))
return echo.EchoGRPC().BasicEcho(ctx, req)


å…³é”®ç‚¹ï¼š

ctx æ˜¯ä»å®¢æˆ·ç«¯è¿›æ¥çš„ Incoming Context

ä½†æ˜¯ gRPC å®¢æˆ·ç«¯è°ƒç”¨éœ€è¦ Outgoing Metadata

gRPC ä¸ä¼šè‡ªåŠ¨æŠŠ Incoming Metadata å˜æˆ Outgoing Metadata

â¡ï¸ æ‰€ä»¥ä½ æŠŠ ctx åŸå°ä¸åŠ¨ä¼ ç»™ BasicEchoï¼Œmetadata æ˜¯ä¸ä¼šå‡ºå»çš„

æ­£ç¡®çš„é€ä¼ å†™æ³•ï¼ˆä½ éœ€è¦æŠŠ Incoming Metadata è½¬æˆ Outgoingï¼‰

æŠŠ metadata è¯»å‡ºæ¥ï¼Œå†å¡å› OutgoingContextï¼š

func (e *Echo) ProxyEcho(ctx context.Context, req *echo.EchoReq) (*echo.EchoResp, error) {
    md, _ := metadata.FromIncomingContext(ctx)
    fmt.Println("incoming:", md)

    // å°† incoming metadata å¤åˆ¶åˆ° outgoingï¼ˆè¿™ä¸€æ­¥éå¸¸å…³é”®ï¼‰
    outCtx := metadata.NewOutgoingContext(ctx, md)

    time.Sleep(2 * time.Second)

    return echo.EchoGRPC().BasicEcho(outCtx, req)
}


ğŸ‘† è¿™æ ·å°±èƒ½æŠŠ metadata ç»§ç»­å¸¦åˆ°ä¸‹æ¸¸ RPCã€‚

âœ”ï¸ è§£é‡Šä¸ºä»€ä¹ˆé»˜è®¤ ctx ä¸è¡Œï¼Ÿ

ä¸€ä¸ª context å¯ä»¥åŒæ—¶åŒ…å« Incoming å’Œ Outgoing metadata å—ï¼Ÿ
å¯ä»¥ï¼Œä½† Incoming ä¸ä¼šè‡ªåŠ¨å˜æˆ Outgoingã€‚

gRPC å¤„ç†æ¨¡å‹ï¼š

ServerHandler â†’ IncomingMetadata

ClientCall â†’ OutgoingMetadata

ä¸¤è€…ä¸è‡ªåŠ¨å…³è”ã€ä¹Ÿä¸ä¼šè‡ªåŠ¨æ‹·è´

åªæœ‰ä½ ä¸»åŠ¨æ‰§è¡Œï¼š

metadata.NewOutgoingContext(ctx, md)


gRPC æ‰çŸ¥é“æŠŠå®ƒå‘å‡ºå»ã€‚

âœ”ï¸ è¡¥å……ï¼šå¦‚æœéœ€è¦ä¿ç•™åŸ income context çš„ deadlineã€cancelï¼Ÿ

å¯ä»¥è¿™æ ·å†™ï¼š
md, _ := metadata.FromIncomingContext(inCtx)
outCtx := metadata.NewOutgoingContext(inCtx, md)


è¿™æ ·ï¼š

deadline

è¶…æ—¶

cancel

éƒ½èƒ½ç»§ç»­ä¼ é€’ã€‚

âœ”ï¸ å¦‚æœä½ å¸Œæœ›ã€Œå®Œå…¨éš”ç¦»ã€ï¼Œå¤åˆ¶ deadlineï¼š
outCtx, cancel := context.WithCancel(context.TODO())
defer cancel()
md, _ := metadata.FromIncomingContext(inCtx)
outCtx = metadata.NewOutgoingContext(outCtx, md)
