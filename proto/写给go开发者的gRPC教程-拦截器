å¼€å¯æ˜é‡‘æˆé•¿ä¹‹æ—…ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 2 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 1 å¤©ï¼Œç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…
æœ¬ç¯‡ä¸ºã€å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹ã€‘ç³»åˆ—ç¬¬ä¸‰ç¯‡
ç¬¬ä¸€ç¯‡ï¼šprotobufåŸºç¡€
ç¬¬äºŒç¯‡ï¼šé€šä¿¡æ¨¡å¼
ç¬¬ä¸‰ç¯‡ï¼šæ‹¦æˆªå™¨ ğŸ‘ˆ
ç¬¬å››ç¯‡ï¼šé”™è¯¯å¤„ç†
ç¬¬äº”ç¯‡ï¼šmetadata
ç¬¬å…­ç¯‡ï¼šè¶…æ—¶æ§åˆ¶
ç¬¬ä¸ƒç¯‡ï¼šå®‰å…¨
ç¬¬å…«ç¯‡ï¼šç”¨æˆ·è®¤è¯
ç¬¬ä¹ç¯‡ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡

gRPCçš„æ‹¦æˆªå™¨å’Œå…¶ä»–æ¡†æ¶çš„æ‹¦æˆªå™¨ï¼ˆä¹Ÿç§°middlewareï¼‰ä½œç”¨æ˜¯ä¸€æ ·çš„ã€‚åˆ©ç”¨æ‹¦æˆªå™¨æˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¾µå…¥ä¸šåŠ¡é€»è¾‘çš„å‰æä¸‹ä¿®æ”¹æˆ–è€…è®°å½•æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸å“åº”ï¼Œå®ç°è¯¸å¦‚æ—¥å¿—è®°å½•ã€æƒé™è®¤è¯ã€é™æµç­‰è¯¸å¤šåŠŸèƒ½
ä¸Šä¸€ç¯‡æåˆ°gRPCçš„é€šä¿¡æ¨¡å¼åˆ†ä¸ºunaryå’Œstreamingå‡ ç§æ¨¡å¼ï¼Œæ‹¦æˆªå™¨ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼šunary interceptorså’Œstreaming interceptors ï¼Œä¸¤ç§æ‹¦æˆªå™¨å¯ä»¥åˆ†åˆ«åº”ç”¨åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œæ‰€ä»¥gRPCæ€»å…±ä¸ºæˆ‘ä»¬æä¾›äº†å››ç§æ‹¦æˆªå™¨ã€‚å®ƒä»¬å·²ç»è¢«å®šä¹‰æˆäº†goä¸­çš„æ¥å£ï¼Œæˆ‘ä»¬åˆ›å»ºçš„æ‹¦æˆªå™¨åªè¦å®ç°è¿™äº›æ¥å£å³å¯

æœåŠ¡ç«¯æ‹¦æˆªå™¨
æœåŠ¡ç«¯çš„æ‹¦æˆªå™¨ä»è¯·æ±‚å¼€å§‹æŒ‰é¡ºåºæ‰§è¡Œæ‹¦æˆªå™¨ï¼Œåœ¨æ‰§è¡Œå®Œå¯¹åº”RPCçš„é€»è¾‘ä¹‹åï¼Œå†æŒ‰åå‘çš„é¡ºåºæ‰§è¡Œæ‹¦æˆªå™¨ä¸­å¯¹å“åº”çš„å¤„ç†é€»è¾‘

unary interceptors
å¯¹äºunaryæœåŠ¡çš„æ‹¦æˆªå™¨åªéœ€å®ç°UnaryServerInterceptoræ¥å£å³å¯
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func(ctx context.Context, req interface{}, 
     info *UnaryServerInfo, handler UnaryHandler) (resp interface{}, err error)


ctx context.Contextï¼šå•ä¸ªè¯·æ±‚çš„ä¸Šä¸‹æ–‡
req interface{}ï¼šRPCæœåŠ¡çš„è¯·æ±‚ç»“æ„ä½“
info *UnaryServerInfoï¼šRPCçš„æœåŠ¡ä¿¡æ¯
handler UnaryHandlerï¼šå®ƒåŒ…è£…äº†æœåŠ¡å®ç°ï¼Œé€šè¿‡è°ƒç”¨å®ƒæˆ‘ä»¬å¯ä»¥å®ŒæˆRPCå¹¶è·å–åˆ°å“åº”

å‚æ•°çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­
ç¤ºä¾‹
å®Œæ•´ä»£ç å‚è€ƒï¼šgithub.com/liangwt/grpâ€¦
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // å®ç° unary interceptors
func orderUnaryServerInterceptor(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {
	// Pre-processing logic
	s := time.Now()

	// Invoking the handler to complete the normal execution of a unary RPC.
	m, err := handler(ctx, req)

	// Post processing logic
	log.Printf("Method: %s, req: %s, resp: %s, latency: %s\n",
		info.FullMethod, req, m, time.Now().Sub(s))
  
	return m, err
}

func main() {
	s := grpc.NewServer(
    // ä½¿ç”¨ unary interceptors
		grpc.UnaryInterceptor(orderUnaryServerInterceptor),
	)
	
  pb.RegisterOrderManagementServer(s, &OrderManagementImpl{})
  
	// ...
}

å‡è®¾æˆ‘ä»¬çš„å®¢æˆ·ç«¯è¯·æ±‚äº†GetOrderï¼Œæ ¹æ®ç¤ºä¾‹å†é‡æ–°çœ‹ä¸‹æ‹¦æˆªå™¨æ¥å£çš„æ¯ä¸€ä¸ªå‚æ•°
ğŸŒ² req interface{}
RPCæœåŠ¡çš„è¯·æ±‚ç»“æ„ä½“ï¼Œå¯¹äºGetOrderæ¥è¯´å°±æ˜¯orderId *wrapperspb.StringValue
ğŸŒ² info *UnaryServerInfoåŒ…å«ä¸¤ä¸ªå­—æ®µï¼š
FullMethodæ˜¯è¯·æ±‚çš„methodåå­—ï¼ˆä¾‹å¦‚/ecommerce.OrderManagement/getOrder)ï¼›
Serverå°±æ˜¯æœåŠ¡å®ç°ï¼ˆå°±æ˜¯ç¤ºä¾‹RegisterOrderManagementServerä¸­çš„&OrderManagementImpl{})
ğŸŒ² handleråŒ…è£…äº†æœåŠ¡å®ç°
æ‰€ä»¥åœ¨è°ƒç”¨å®ƒä¹‹å‰æˆ‘ä»¬å¯ä»¥è¿›è¡Œæ”¹å†™reqæˆ–ctxã€è®°å½•é€»è¾‘å¼€å§‹æ—¶é—´ç­‰æ“ä½œ
è°ƒç”¨å®Œhandlerå³å®Œæˆäº†RPCå¹¶è·å–åˆ°å“åº”ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥è®°å½•å“åº”è¿˜å¯ä»¥æ”¹å†™å“åº”
æ€»ç»“
è¿™å¼ å›¾å¤§è‡´å±•ç¤ºäº†UnaryServerInterceptoræ¥å£çš„æ¯ä¸ªå‚æ•°çš„å«ä¹‰

streaming interceptors
å¯¹äºstreamæœåŠ¡çš„æ‹¦æˆªå™¨åªè¦å®ç°StreamServerInterceptoræ¥å£å³å¯ã€‚å®ƒé€‚ç”¨äºæˆ‘ä»¬ä¸Šä¸€ç¯‡ä»‹ç»çš„

æœåŠ¡å™¨ç«¯æµå¼ RPC
å®¢æˆ·ç«¯æµå¼ RPC
åŒå‘æµå¼ RPC

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func(srv interface{}, ss ServerStream, 
     info *StreamServerInfo, handler StreamHandler) error


srv interface{}ï¼šæœåŠ¡å®ç°
ss ServerStreamï¼šæœåŠ¡ç«¯è§†è§’çš„æµã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿæ— è®ºæ˜¯å“ªä¸€ç§æµå¼RPCå¯¹äºæœåŠ¡ç«¯æ¥è¯´å‘é€ï¼ˆSendMsgï¼‰å°±ä»£è¡¨ç€å“åº”æ•°æ®ï¼Œæ¥æ”¶ï¼ˆRecvMsgï¼‰å°±ä»£è¡¨ç€è¯·æ±‚æ•°æ®ï¼Œä¸åŒçš„æµå¼RPCçš„åŒºåˆ«å°±åœ¨äºæ˜¯å¤šæ¬¡å‘é€æ•°æ®ï¼ˆæœåŠ¡å™¨ç«¯æµå¼ RPCï¼‰è¿˜æ˜¯å¤šæ¬¡æ¥æ”¶æ•°æ®ï¼ˆå®¢æˆ·ç«¯æµå¼ RPCï¼‰æˆ–è€…ä¸¤è€…å‡æœ‰ï¼ˆåŒå‘æµå¼ RPCï¼‰ã€‚å› æ­¤ä»…ä½¿ç”¨è¿™ä¸€ä¸ªæŠ½è±¡å°±ä»£è¡¨äº†æ‰€æœ‰çš„æµå¼RPCåœºæ™¯
info *StreamServerInfoï¼šRPCçš„æœåŠ¡ä¿¡æ¯
handler StreamHandlerï¼šå®ƒåŒ…è£…äº†æœåŠ¡å®ç°ï¼Œé€šè¿‡è°ƒç”¨å®ƒæˆ‘ä»¬å¯ä»¥å®ŒæˆRPC

ç¤ºä¾‹
æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­
å®Œæ•´ä»£ç å‚è€ƒï¼šgithub.com/liangwt/grpâ€¦
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func orderStreamServerInterceptor(srv interface{},
	ss grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler) error {

	// Pre-processing logic
	s := time.Now()

	// Invoking the StreamHandler to complete the execution of RPC invocation
	err := handler(srv, ss)

	// Post processing logic
	log.Printf("Method: %s, latency: %s\n", info.FullMethod, time.Now().Sub(s))

	return err
}

func main() {
	s := grpc.NewServer(
		grpc.StreamInterceptor(orderStreamServerInterceptor),
	)

	pb.RegisterOrderManagementServer(s, &OrderManagementImpl{})

	//...
}

æ ¹æ®ç¤ºä¾‹å†é‡æ–°çœ‹ä¸‹æ‹¦æˆªå™¨æ¥å£çš„å‚æ•°
ğŸŒ² srv interface{}
â€‹    æœåŠ¡å®ç°ï¼ˆå°±æ˜¯ç¤ºä¾‹RegisterOrderManagementServerä¸­çš„&OrderManagementImpl{})
ğŸŒ² ss grpc.ServerStream
â€‹    æœåŠ¡ç«¯å‘é€å’Œæ¥æ”¶æ•°æ®çš„æ¥å£ï¼Œæ³¨æ„å®ƒæ˜¯ä¸€ä¸ªæ¥å£
ğŸŒ² info *grpc.StreamServerInfoåŒ…å«ä¸‰ä¸ªå­—æ®µï¼š
â€‹    FullMethodæ˜¯è¯·æ±‚çš„methodåå­—ï¼ˆä¾‹å¦‚/ecommerce.OrderManagement/updateOrders)ï¼›
â€‹    IsClientStream æ˜¯å¦æ˜¯å®¢æˆ·ç«¯æµ
â€‹    IsServerStream æ˜¯å¦æ˜¯æœåŠ¡ç«¯æµ
ğŸŒ² handleråŒ…è£…äº†æœåŠ¡å®ç°
â€‹    æ‰€ä»¥åœ¨è°ƒç”¨å®ƒä¹‹å‰æˆ‘ä»¬å¯ä»¥è¿›è¡Œæ”¹å†™æ•°æ®æµã€è®°å½•é€»è¾‘å¼€å§‹æ—¶é—´ç­‰æ“ä½œ
â€‹    è°ƒç”¨å®Œhandlerå³å®Œæˆäº†RPCï¼Œå› ä¸ºæ˜¯æµå¼è°ƒç”¨æ‰€ä»¥ä¸ä¼šè¿”å›å“åº”æ•°æ®ï¼Œåªæœ‰error
æµå¼æ‹¦æˆªå™¨æ—¢æ²¡æœ‰è¯·æ±‚å­—æ®µï¼Œhandlerä¹Ÿä¸ä¼šè¿”å›å“åº”ï¼Œè¯¥å¦‚ä½•è®°å½•ã€ä¿®æ”¹è¯·æ±‚å“åº”å‘¢ï¼Ÿ
å¦‚æœæƒ³åŠ«æŒæµæ•°æ®ï¼Œç­”æ¡ˆå°±åœ¨ss ServerStreamã€‚å†é‡å¤ä¸€éå®ƒçš„å«ä¹‰ï¼šæœåŠ¡ç«¯è§†è§’çš„æµï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ã€‚æ— è®ºæ˜¯å“ªä¸€ç§æµå¼RPCå¯¹äºæœåŠ¡ç«¯æ¥è¯´å‘é€ï¼ˆSendMsgï¼‰å°±ä»£è¡¨ç€å“åº”æ•°æ®ï¼Œæ¥æ”¶ï¼ˆRecvMsgï¼‰å°±ä»£è¡¨ç€è¯·æ±‚æ•°æ®ï¼Œä¸åŒçš„æµå¼RPCçš„åŒºåˆ«å°±åœ¨äºæ˜¯å¤šæ¬¡å‘é€æ•°æ®ï¼ˆæœåŠ¡å™¨ç«¯æµå¼ RPCï¼‰è¿˜æ˜¯å¤šæ¬¡æ¥æ”¶æ•°æ®ï¼ˆå®¢æˆ·ç«¯æµå¼ RPCï¼‰æˆ–è€…ä¸¤è€…å‡æœ‰ï¼ˆåŒå‘æµå¼ RPCï¼‰ã€‚å› æ­¤å¯ä»¥å¯¹ssè¿›è¡ŒåŒ…è£…ï¼Œåªè¦ä¼ å…¥handlerçš„ç±»å‹å®ç°ServerStreamå³å¯
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // SendMsg method call.
type wrappedStream struct {
	Recv []interface{}
	Send []interface{}
	grpc.ServerStream
}

func (w *wrappedStream) RecvMsg(m interface{}) error {
	err := w.ServerStream.RecvMsg(m)

	w.Recv = append(w.Recv, m)

	return err
}

func (w *wrappedStream) SendMsg(m interface{}) error {
	err := w.ServerStream.SendMsg(m)

	w.Send = append(w.Send, m)

	return err
}

func newWrappedStream(s grpc.ServerStream) *wrappedStream {
	return &wrappedStream{
		make([]interface{}, 0),
		make([]interface{}, 0),
		s,
	}
}

func orderStreamServerInterceptor(srv interface{},
	ss grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler) error {

	// Pre-processing logic
	s := time.Now()

	// Invoking the StreamHandler to complete the execution of RPC invocation
	nss := newWrappedStream(ss)
	err := handler(srv, nss)

	// Post processing logic
	log.Printf("Method: %s, req: %+v, resp: %+v, latency: %s\n",
		info.FullMethod, nss.Recv, nss.Send, time.Now().Sub(s))

	return err
}

å®¢æˆ·ç«¯æ‹¦æˆªå™¨
å®¢æˆ·ç«¯æ‹¦æˆªå™¨å’ŒæœåŠ¡ç«¯æ‹¦æˆªå™¨ç±»ä¼¼ï¼Œä»è¯·æ±‚å¼€å§‹æŒ‰é¡ºåºæ‰§è¡Œæ‹¦æˆªå™¨ï¼Œåœ¨è·å–åˆ°æœåŠ¡ç«¯å“åº”ä¹‹åï¼Œå†æŒ‰åå‘çš„é¡ºåºæ‰§è¡Œæ‹¦æˆªå™¨ä¸­å¯¹å“åº”çš„å¤„ç†é€»è¾‘

unary interceptors
clientç«¯è¦å®ç°UnaryClientInterceptoræ¥å£å®ç°çš„æ¥å£å¦‚ä¸‹
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func(ctx context.Context, method string, req, reply interface{}, 
     cc *ClientConn, invoker UnaryInvoker, opts ...CallOption) error

ä½ å¯ä»¥åœ¨è°ƒç”¨è¿œç¨‹å‡½æ•°å‰æ‹¦æˆªRPCï¼Œé€šè¿‡è·å–RPCç›¸å…³ä¿¡æ¯ï¼Œå¦‚å‚æ•°ï¼Œä¸Šä¸‹æ–‡ï¼Œå‡½æ•°åï¼Œè¯·æ±‚ç­‰ï¼Œä½ ç”šè‡³å¯ä»¥ä¿®æ”¹åŸå§‹çš„è¿œç¨‹è°ƒç”¨

ctx context.Contextï¼šå•ä¸ªè¯·æ±‚çš„ä¸Šä¸‹æ–‡
method stringï¼šè¯·æ±‚çš„methodåå­—ï¼ˆä¾‹å¦‚/ecommerce.OrderManagement/getOrder)
req, reply interface{}ï¼šè¯·æ±‚å’Œå“åº”æ•°æ®
cc *ClientConnï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é“¾æ¥
invoker UnaryInvokerï¼šé€šè¿‡è°ƒç”¨å®ƒæˆ‘ä»¬å¯ä»¥å®ŒæˆRPCå¹¶è·å–åˆ°å“åº”
opts ...CallOptionï¼šRPCè°ƒç”¨çš„æ‰€æœ‰é…ç½®é¡¹ï¼ŒåŒ…å«è®¾ç½®åˆ°connä¸Šçš„ï¼Œä¹ŸåŒ…å«é…ç½®åœ¨æ¯ä¸€ä¸ªè°ƒç”¨ä¸Šçš„

ç¤ºä¾‹
å®Œæ•´ä»£ç å‚è€ƒï¼šgithub.com/liangwt/grpâ€¦
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func orderUnaryClientInterceptor(ctx context.Context, method string, req, reply interface{},
	cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error {
	// Pre-processor phase
	s := time.Now()

	// Invoking the remote method
	err := invoker(ctx, method, req, reply, cc, opts...)

	// Post-processor phase
	log.Printf("method: %s, req: %s, resp: %s, latency: %s\n",
		method, req, reply, time.Now().Sub(s))

	return err
}

func main() {
	conn, err := grpc.Dial("127.0.0.1:8009",
		grpc.WithInsecure(),
		grpc.WithUnaryInterceptor(orderUnaryClientInterceptor),
	)
	if err != nil {
		panic(err)
	}

	c := pb.NewOrderManagementClient(conn)
  
  // ...
}

æ ¹æ®ç¤ºä¾‹å†é‡æ–°çœ‹ä¸‹æ‹¦æˆªå™¨æ¥å£çš„å‚æ•°
ğŸŒ² cc *grpc.ClientConnå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é“¾æ¥
â€‹    è¿™é‡Œçš„ccå°±æ˜¯ç¤ºä¾‹ä»£ç ä¸­c := pb.NewOrderManagementClient(conn)çš„conn
ğŸŒ² invoker grpc.UnaryInvokeråŒ…è£…äº†æœåŠ¡å®ç°
â€‹     è°ƒç”¨å®Œinvokerå³å®Œæˆäº†RPCï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¹å†™reqæˆ–è€…åœ¨è·å–åˆ°replyä¹‹åä¿®æ”¹å“åº”

streaming interceptors
è¦å®ç°çš„æ¥å£StreamClientInterceptor
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func(ctx context.Context, desc *StreamDesc, cc *ClientConn, 
     method string, streamer Streamer, opts ...CallOption) (ClientStream, error)

å’Œserveç«¯ç±»ä¼¼çš„å‚æ•°ç±»ä¼¼ï¼Œé‡ç‚¹å…³æ³¨ä¸‹é¢å‡ ä¸ªå‚æ•°

cs ClientStreamï¼šå®¢æˆ·ç«¯è§†è§’çš„æµã€‚ç±»æ¯”æœåŠ¡ç«¯çš„ss ServerStreamï¼Œæ— è®ºæ˜¯å“ªä¸€ç§æµå¼RPCå¯¹äºå®¢æˆ·ç«¯æ¥è¯´å‘é€ï¼ˆSendMsgï¼‰å°±ä»£è¡¨ç€è¯·æ±‚æ•°æ®ï¼Œæ¥æ”¶ï¼ˆRecvMsgï¼‰å°±ä»£è¡¨ç€å“åº”æ•°æ®ï¼ˆæ­£å¥½å’ŒæœåŠ¡ç«¯æ˜¯åè¿‡æ¥çš„ï¼‰
streamer Streamerï¼šå®ŒæˆRPCè¯·æ±‚çš„è°ƒç”¨

ç¤ºä¾‹
è¿™é‡Œä¸å†èµ˜è¿°ï¼Œå¯ä»¥å‚è€ƒæœåŠ¡ç«¯æ‹¦æˆªå™¨
å®Œæ•´ä»£ç å‚è€ƒï¼šgithub.com/liangwt/grpâ€¦
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func orderStreamClientInterceptor(ctx context.Context, desc *grpc.StreamDesc,
	cc *grpc.ClientConn, method string, streamer grpc.Streamer,
	opts ...grpc.CallOption) (grpc.ClientStream, error) {

	// Pre-processing logic
	s := time.Now()

	cs, err := streamer(ctx, desc, cc, method, opts...)

	// Post processing logic
	log.Printf("method: %s, latency: %s\n", method, time.Now().Sub(s))

	return cs, err
}

func main() {
	conn, err := grpc.Dial("127.0.0.1:8009",
		grpc.WithInsecure(),
		grpc.WithStreamInterceptor(orderStreamClientInterceptor),
	)
	if err != nil {
		panic(err)
	}

	c := pb.NewOrderManagementClient(conn)
  
  // ...
}

å¦‚ä½•è®°å½•æˆ–è€…ä¿®æ”¹æµæ‹¦æˆªå™¨çš„è¯·æ±‚å“åº”æ•°æ®ï¼Ÿ
å’ŒæœåŠ¡ç«¯stream interceptoråŒæ ·çš„é“ç†ï¼Œé€šè¿‡åŒ…è£…ClientStreamå³å¯åšåˆ°
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // SendMsg method call.
type wrappedStream struct {
	method string
	grpc.ClientStream
}

func (w *wrappedStream) RecvMsg(m interface{}) error {
	err := w.ClientStream.RecvMsg(m)

	log.Printf("method: %s, res: %s\n", w.method, m)

	return err
}

func (w *wrappedStream) SendMsg(m interface{}) error {
	err := w.ClientStream.SendMsg(m)

	log.Printf("method: %s, req: %s\n", w.method, m)

	return err
}

func newWrappedStream(method string, s grpc.ClientStream) *wrappedStream {
	return &wrappedStream{
		method,
		s,
	}
}

func orderStreamClientInterceptor(ctx context.Context, desc *grpc.StreamDesc,
	cc *grpc.ClientConn, method string, streamer grpc.Streamer,
	opts ...grpc.CallOption) (grpc.ClientStream, error) {

	// Pre-processing logic
	s := time.Now()

	cs, err := streamer(ctx, desc, cc, method, opts...)

	// Post processing logic
	log.Printf("method: %s, latency: %s\n", method, time.Now().Sub(s))

	return newWrappedStream(method, cs), err
}

æ‹¦æˆªå™¨é“¾
æœåŠ¡å™¨åªèƒ½é…ç½®ä¸€ä¸ª unary interceptorå’Œ stream interceptorï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ˜¯ï¼Œè™½ç„¶ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯åªæœ‰æœ€åä¸€ä¸ªæ‰èµ·ä½œç”¨ã€‚
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // æœåŠ¡ç«¯æ‹¦æˆªå™¨
s := grpc.NewServer(
  grpc.UnaryInterceptor(orderUnaryServerInterceptor),
  grpc.StreamInterceptor(orderStreamServerInterceptor),
)

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // å®¢æˆ·ç«¯æ‹¦æˆªå™¨
conn, err := grpc.Dial("127.0.0.1:8009",
		grpc.WithInsecure(),
		grpc.WithUnaryInterceptor(orderUnaryClientInterceptor),
		grpc.WithStreamInterceptor(orderStreamClientInterceptor),
)

å¦‚æœä½ æƒ³é…ç½®å¤šä¸ªï¼Œå¯ä»¥ä½¿ç”¨æ‹¦æˆªå™¨é“¾æˆ–è€…è‡ªå·±å®ç°ä¸€ä¸ªã€‚
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // æœåŠ¡ç«¯æ‹¦æˆªå™¨
s := grpc.NewServer(
  grpc.ChainUnaryInterceptor(
    orderUnaryServerInterceptor1,
    orderUnaryServerInterceptor2,
  ),
  grpc.ChainStreamInterceptor(
    orderServerStreamInterceptor1,
    orderServerStreamInterceptor2,
  ),
)

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // å®¢æˆ·ç«¯æ‹¦æˆªå™¨
conn, err := grpc.Dial("127.0.0.1:8009",
		grpc.WithInsecure(),
		grpc.WithChainUnaryInterceptor(
			orderUnaryClientInterceptor1,
      orderUnaryClientInterceptor2,
		),
		grpc.WithChainStreamInterceptor(
			orderStreamClientInterceptor1,
      orderStreamClientInterceptor2,
		),
)

ç”Ÿæ€
é™¤äº†å¯ä»¥è‡ªå·±å®ç°æ‹¦æˆªå™¨å¤–ï¼ŒgRPCç”Ÿæ€ä¹Ÿæä¾›äº†ä¸€ç³»åˆ—çš„å¼€æºçš„æ‹¦æˆªå™¨å¯ä¾›ä½¿ç”¨ï¼Œè¦†ç›–æƒé™ã€æ—¥å¿—ã€ç›‘æ§ç­‰è¯¸å¤šæ–¹é¢
github.com/grpc-ecosysâ€¦
Auth

grpc_auth - a customizable (via AuthFunc) piece of auth middleware

Logging

grpc_ctxtags - a library that adds a Tag map to context, with data populated from request body
grpc_zap - integration of zap logging library into gRPC handlers.
grpc_logrus - integration of logrus logging library into gRPC handlers.
grpc_kit - integration of go-kit/log logging library into gRPC handlers.
grpc_grpc_logsettable - a wrapper around grpclog.LoggerV2 that allows to replace loggers in runtime (thread-safe).

Monitoring

grpc_prometheusâš¡ - Prometheus client-side and server-side monitoring middleware
otgrpcâš¡ - OpenTracing client-side and server-side interceptors
grpc_opentracing - OpenTracing client-side and server-side interceptors with support for streaming and handler-returned tags

Client

grpc_retry - a generic gRPC response code retry mechanism, client-side middleware

Server

grpc_validator - codegen inbound message validation from .proto options
grpc_recovery - turn panics into gRPC errors
ratelimit - grpc rate limiting by your own limiter

ç¤ºä¾‹ä»£ç 
github.com/liangwt/grpâ€¦


ä½œè€…ï¼šå‡‰å‡‰çš„çŸ¥è¯†åº“
é“¾æ¥ï¼šhttps://juejin.cn/post/7196150790367805477
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
