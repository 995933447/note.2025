æœ¬ç¯‡ä¸ºã€å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹ç³»åˆ—ã€‘ç¬¬äº”ç¯‡
ç¬¬ä¸€ç¯‡ï¼šprotobufåŸºç¡€
ç¬¬äºŒç¯‡ï¼šé€šä¿¡æ¨¡å¼
ç¬¬ä¸‰ç¯‡ï¼šæ‹¦æˆªå™¨
ç¬¬å››ç¯‡ï¼šé”™è¯¯å¤„ç†
ç¬¬äº”ç¯‡ï¼šmetadata ğŸ‘ˆ
æœ¬ç³»åˆ—å°†æŒç»­æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ğŸ‘è·å–å®æ—¶é€šçŸ¥

å¼€å¯æ˜é‡‘æˆé•¿ä¹‹æ—…ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 2 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬ 3 å¤©ï¼Œç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…

å¯¼è¯­
å’Œåœ¨æ™®é€šHTTPè¯·æ±‚ä¸­ä¸€æ ·ï¼ŒgRPCæä¾›äº†åœ¨æ¯ä¸€æ¬¡RPCä¸­æºå¸¦çš„ä¸Šä¸‹æ–‡ç»“æ„ï¼šmetadataã€‚åœ¨Goè¯­è¨€ä¸­ï¼Œå®ƒä¸context.Contextç´§å¯†ç»“åˆï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´äº’ç›¸ä¼ é€’ä¿¡æ¯

ä»€ä¹ˆæ˜¯metadataï¼Ÿ
gRPC çš„ metadata ç®€å•ç†è§£ï¼Œå°±æ˜¯ HTTP Header  ä¸­çš„ key-value å¯¹


metadata æ˜¯ä»¥ key-value çš„å½¢å¼å­˜å‚¨æ•°æ®çš„ï¼Œå…¶ä¸­ key æ˜¯ string ç±»å‹ï¼Œè€Œ value æ˜¯ []stringï¼Œå³ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ç±»å‹


metadata ä½¿å¾— client å’Œ server èƒ½å¤Ÿä¸ºå¯¹æ–¹æä¾›å…³äºæœ¬æ¬¡è°ƒç”¨çš„ä¸€äº›ä¿¡æ¯ï¼Œå°±åƒä¸€æ¬¡HTTPè¯·æ±‚çš„Request Headerå’ŒResponse Headerä¸€æ ·


HTTP Header çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ¬¡ HTTP è¯·æ±‚ï¼Œé‚£ä¹ˆ metadata çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ä¸€æ¬¡ RPC è°ƒç”¨


metadata åˆ›å»º
ğŸŒ² ä½¿ç”¨New()ï¼š
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç md := metadata.New(map[string]string{"key1":"value1","key2":"value2"})

ğŸŒ² ä½¿ç”¨Pairs()ï¼š
è¦æ³¨æ„å¦‚æœæœ‰ç›¸åŒçš„ key ä¼šè‡ªåŠ¨åˆå¹¶
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç md := metadata.Pairs(
    "key1", "value1",
    "key1", "value1.2", // "key1" will have map value []string{"value1", "value1.2"}
    "key2", "value2",
)

ğŸŒ² åˆå¹¶å¤šä¸ªmetadata
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç md1 :=  metadata.Pairs("k1", "v1", "k2", "v2")
md2 := metadata.New(map[string]string{"key1":"value1","key2":"value2"})

md := metadata.Join(md1, md2)

ğŸŒ² å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®
åœ¨ metadata ä¸­ï¼Œkey æ°¸è¿œæ˜¯ string ç±»å‹ï¼Œä½†æ˜¯ value å¯ä»¥æ˜¯ string ä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶æ•°æ®ã€‚ä¸ºäº†åœ¨ metadata ä¸­å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦åœ¨ key çš„åé¢åŠ ä¸Šä¸€ä¸ª - bin åç¼€ã€‚å…·æœ‰ - bin åç¼€çš„ key æ‰€å¯¹åº”çš„ value åœ¨åˆ›å»º metadata æ—¶ä¼šè¢«ç¼–ç ï¼ˆbase64ï¼‰ï¼Œæ”¶åˆ°çš„æ—¶å€™ä¼šè¢«è§£ç ï¼š
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç md := metadata.Pairs(
    "key", "string value",
    "key-bin", string([]byte{96, 102}),
)

metadata ç»“æ„æœ¬èº«ä¹Ÿæœ‰ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œå‚è€ƒæ–‡æ¡£éå¸¸å®¹æ˜“ç†è§£ã€‚è¿™é‡Œä¸å†èµ˜è¿°ï¼špkg.go.dev/google.golaâ€¦
metadata å‘é€ä¸æ¥æ”¶
è®©æˆ‘ä»¬å†æ¬¡å›é¡¾ä¸‹pbæ–‡ä»¶å’Œç”Ÿæˆå‡ºæ¥çš„clientä¸serverç«¯çš„æ¥å£
protobuf ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç service OrderManagement {
    rpc getOrder(google.protobuf.StringValue) returns (Order);
}

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç type OrderManagementClient interface {
	GetOrder(ctx context.Context, 
           in *wrapperspb.StringValue, opts ...grpc.CallOption) (*Order, error)
}

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç type OrderManagementServer interface {
	GetOrder(context.Context, *wrapperspb.StringValue) (*Order, error)
	mustEmbedUnimplementedOrderManagementServer()
}

å¯ä»¥çœ‹åˆ°ç›¸æ¯”pbä¸­çš„æ¥å£å®šä¹‰ï¼Œç”Ÿæˆå‡ºæ¥çš„Goä»£ç é™¤äº†å¢åŠ äº†errorè¿”å›å€¼ï¼Œè¿˜å¤šäº†context.Context
å’Œé”™è¯¯å¤„ç†ç±»ä¼¼ï¼ŒgRPCä¸­çš„context.Context ä¹Ÿç¬¦åˆGoè¯­è¨€çš„ä½¿ç”¨ä¹ æƒ¯ï¼šé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬åœ¨å‡½æ•°é¦–ä¸ªå‚æ•°æ”¾ç½®context.Contextç”¨æ¥ä¼ é€’ä¸€æ¬¡RPCä¸­æœ‰å…³çš„ä¸Šä¸‹æ–‡ï¼Œå€ŸåŠ©context.WithValue()æˆ–ctx.Value()å¾€contextæ·»åŠ å˜é‡æˆ–è¯»å–å˜é‡
metadataå°±æ˜¯gRPCä¸­å¯ä»¥ä¼ é€’çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ä¹‹ä¸€ï¼Œæ‰€ä»¥metadataçš„ä½¿ç”¨æ–¹å¼å°±æ˜¯ï¼šmetadataè®°å½•åˆ°contextï¼Œä»contextè¯»å–metadata

Clinetå‘é€Serveræ¥æ”¶
clientå‘é€metadataï¼Œé‚£å°±æ˜¯æŠŠmetadataå­˜å‚¨åˆ°contex.Context
serveræ¥æ”¶metadataï¼Œå°±æ˜¯ä»contex.Contextä¸­è¯»å–Metadata
Clinet å‘é€ Metadata
æŠŠMetadataæ”¾åˆ°contex.Contextï¼Œæœ‰å‡ ç§æ–¹å¼
ğŸŒ² ä½¿ç”¨NewOutgoingContext
å°†æ–°åˆ›å»ºçš„metadataæ·»åŠ åˆ°contextä¸­ï¼Œè¿™æ ·ä¼š è¦†ç›– æ‰åŸæ¥å·²æœ‰çš„metadata
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // å°†metadataæ·»åŠ åˆ°contextä¸­ï¼Œè·å–æ–°çš„context
md := metadata.Pairs("k1", "v1", "k1", "v2", "k2", "v3")
ctx := metadata.NewOutgoingContext(context.Background(), md)

// unary RPC
response, err := client.SomeRPC(ctx, someRequest)

// streaming RPC
stream, err := client.SomeStreamingRPC(ctx)

ğŸŒ² ä½¿ç”¨AppendToOutgoingContext
å¯ä»¥ç›´æ¥å°† key-value å¯¹æ·»åŠ åˆ°å·²æœ‰çš„contextä¸­


å¦‚æœcontextä¸­æ²¡æœ‰metadataï¼Œé‚£ä¹ˆå°±ä¼š åˆ›å»º ä¸€ä¸ª


å¦‚æœå·²æœ‰metadataï¼Œé‚£ä¹ˆå°±å°†æ•°æ® æ·»åŠ  åˆ°åŸæ¥çš„metadata


go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // å¦‚æœå¯¹åº”çš„ context æ²¡æœ‰ metadataï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºä¸€ä¸ª
ctx := metadata.AppendToOutgoingContext(ctx, "k1", "v1", "k1", "v2", "k2", "v3")

// å¦‚æœå·²æœ‰ metadata äº†ï¼Œé‚£ä¹ˆå°±å°†æ•°æ®æ·»åŠ åˆ°åŸæ¥çš„ metadata  (ä¾‹å¦‚åœ¨æ‹¦æˆªå™¨ä¸­)
ctx := metadata.AppendToOutgoingContext(ctx, "k3", "v4")

// æ™®é€šRPCï¼ˆunary RPCï¼‰
response, err := client.SomeRPC(ctx, someRequest)

// æµå¼RPCï¼ˆstreaming RPCï¼‰
stream, err := client.SomeStreamingRPC(ctx)

Server æ¥æ”¶ Metedata
æ™®é€šRPCä¸æµå¼RPCçš„åŒºåˆ«ä¸å¤§ï¼Œéƒ½æ˜¯ä»contex.Contextä¸­è¯»å–metadata
ğŸŒ² ä½¿ç”¨FromIncomingContext
æ™®é€šRPCï¼ˆunary RPCï¼‰
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç //Unary Call
func (s *server) SomeRPC(ctx context.Context, in *pb.someRequest) (*pb.someResponse, error) {
    md, ok := metadata.FromIncomingContext(ctx)
    // do something with metadata
}

æµå¼RPCï¼ˆstreaming RPCï¼‰
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç //Streaming Call
func (s *server) SomeStreamingRPC(stream pb.Service_SomeStreamingRPCServer) error {
    md, ok := metadata.FromIncomingContext(stream.Context()) // get context from stream
    // do something with metadata
}

Serverå‘é€Clinetæ¥æ”¶
æœåŠ¡ç«¯å‘é€çš„metadataè¢«åˆ†æˆäº†headerå’Œ trailerä¸¤è€…ï¼Œå› è€Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è¯»å–ä¸¤è€…
Server å‘é€ Metadata
å¯¹äº**æ™®é€šRPCï¼ˆunary RPCï¼‰**serverå¯ä»¥ä½¿ç”¨grpcåŒ…ä¸­æä¾›çš„å‡½æ•°å‘clientå‘é€ header å’Œtrailer

grpc.SendHeader()
grpc.SetHeader()
grpc.SetTrailer()

å¯¹äº**æµå¼RPCï¼ˆstreaming RPCï¼‰serverå¯ä»¥ä½¿ç”¨ServerStreamæ¥å£ä¸­å®šä¹‰çš„å‡½æ•°å‘clientå‘é€headerå’Œ trailer

ServerStream.SendHeader()
ServerStream.SetHeader()
ServerStream.SetTrailer()

ğŸŒ² æ™®é€šRPCï¼ˆunary RPCï¼‰
ä½¿ç”¨ grpc.SendHeader()  å’Œ grpc.SetTrailer() æ–¹æ³• ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°†context.Contextä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func (s *server) SomeRPC(ctx context.Context, in *pb.someRequest) (*pb.someResponse, error) {
  // åˆ›å»ºå¹¶å‘é€header
  header := metadata.Pairs("header-key", "val")
  grpc.SendHeader(ctx, header)
  
  // åˆ›å»ºå¹¶å‘é€trailer
  trailer := metadata.Pairs("trailer-key", "val")
  grpc.SetTrailer(ctx, trailer)
}

å¦‚æœä¸æƒ³ç«‹å³å‘é€headerï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨grpc.SetHeader()ã€‚grpc.SetHeader()å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œåœ¨å¦‚ä¸‹æ—¶æœºä¼šæŠŠå¤šä¸ªmetadataåˆå¹¶å‘é€å‡ºå»

è°ƒç”¨grpc.SendHeader() 
ç¬¬ä¸€ä¸ªå“åº”è¢«å‘é€æ—¶
RPCç»“æŸæ—¶ï¼ˆåŒ…å«æˆåŠŸæˆ–å¤±è´¥ï¼‰

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func (s *server) SomeRPC(ctx context.Context, in *pb.someRequest) (*pb.someResponse, error) {
  // åˆ›å»ºheaderï¼Œåœ¨é€‚å½“æ—¶æœºä¼šè¢«å‘é€
  header := metadata.Pairs("header-key1", "val1")
  grpc.SetHeader(ctx, header)
    
  // åˆ›å»ºheaderï¼Œåœ¨é€‚å½“æ—¶æœºä¼šè¢«å‘é€
  header := metadata.Pairs("header-key2", "val2")
  grpc.SetHeader(ctx, header)
  
  // åˆ›å»ºå¹¶å‘é€trailer
  trailer := metadata.Pairs("trailer-key", "val")
  grpc.SetTrailer(ctx, trailer)
}

ğŸŒ² æµå¼RPCï¼ˆstreaming RPCï¼‰
ä½¿ç”¨ ServerStream.SendHeader() å’Œ ServerStream.SetTrailer() æ–¹æ³•
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func (s *server) SomeStreamingRPC(stream pb.Service_SomeStreamingRPCServer) error {
  // create and send header
  header := metadata.Pairs("header-key", "val")
  stream.SendHeader(header)
  
  // create and set trailer
  trailer := metadata.Pairs("trailer-key", "val")
  stream.SetTrailer(trailer)
}

å¦‚æœä¸æƒ³ç«‹å³å‘é€headerï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ServerStream.SetHeader()ã€‚ServerStream.SetHeader()å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œåœ¨å¦‚ä¸‹æ—¶æœºä¼šæŠŠå¤šä¸ªmetadataåˆå¹¶å‘é€å‡ºå»

è°ƒç”¨ServerStream.SendHeader()
ç¬¬ä¸€ä¸ªå“åº”è¢«å‘é€æ—¶
RPCç»“æŸæ—¶ï¼ˆåŒ…å«æˆåŠŸæˆ–å¤±è´¥ï¼‰

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func (s *server) SomeStreamingRPC(stream pb.Service_SomeStreamingRPCServer) error {
  // create and send header
  header := metadata.Pairs("header-key", "val")
  stream.SetHeader(header)
  
  // create and set trailer
  trailer := metadata.Pairs("trailer-key", "val")
  stream.SetTrailer(trailer)
}

Client æ¥æ”¶ Metadata
ğŸŒ² æ™®é€šRPCï¼ˆunary RPCï¼‰
**æ™®é€šRPCï¼ˆunary RPCï¼‰**ä½¿ç”¨grpc.Header()å’Œgrpc.Trailer()æ–¹æ³•æ¥æ¥æ”¶ Metadata
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // RPC using the context with new metadata.
var header, trailer metadata.MD

// Add Order
order := pb.Order{Id: "101", Items: []string{"iPhone XS", "Mac Book Pro"}, Destination: "San Jose, CA", Price: 2300.00}
res, err := client.AddOrder(ctx, &order, grpc.Header(&header), grpc.Trailer(&trailer))
if err != nil {
  panic(err)
}

ğŸŒ² æµå¼RPCï¼ˆstreaming RPCï¼‰
**æµå¼RPCï¼ˆstreaming RPCï¼‰**é€šè¿‡è°ƒç”¨è¿”å›çš„ ClientStreamæ¥å£çš„Header()å’Œ Trailer()æ–¹æ³•æ¥æ”¶ metadata
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç stream, err := client.SomeStreamingRPC(ctx)

// retrieve header
header, err := stream.Header()

stream.CloseAndRecv()

// retrieve trailer
trailer := stream.Trailer()

Headerå’ŒTraileråŒºåˆ«
æ ¹æœ¬åŒºåˆ«ï¼šå‘é€çš„æ—¶æœºä¸åŒï¼
âœ¨ headersä¼šåœ¨ä¸‹é¢ä¸‰ç§åœºæ™¯ä¸‹è¢«å‘é€

SendHeader() è¢«è°ƒç”¨æ—¶ï¼ˆåŒ…å«grpc.SendHeaderå’Œstream.SendHeader)
ç¬¬ä¸€ä¸ªå“åº”è¢«å‘é€æ—¶
RPCç»“æŸæ—¶ï¼ˆåŒ…å«æˆåŠŸæˆ–å¤±è´¥ï¼‰

âœ¨ trailerä¼šåœ¨rpcè¿”å›çš„æ—¶å€™ï¼Œå³è¿™ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™è¢«å‘é€
å·®å¼‚åœ¨æµå¼RPCï¼ˆstreaming RPCï¼‰ä¸­æ¯”è¾ƒæ˜æ˜¾ï¼š
å› ä¸ºtraileræ˜¯åœ¨æœåŠ¡ç«¯å‘é€å®Œè¯·æ±‚ä¹‹åæ‰å‘é€çš„ï¼Œæ‰€ä»¥clientè·å–trailerçš„æ—¶å€™éœ€è¦åœ¨stream.CloseAndRecvæˆ–è€…stream.Recv è¿”å›énilé”™è¯¯ (åŒ…å« io.EOF)ä¹‹å
å¦‚æœstream.CloseAndRecvä¹‹å‰è°ƒç”¨stream.Trailer()è·å–çš„æ˜¯ç©º
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç stream, err := client.SomeStreamingRPC(ctx)

// retrieve header
header, err := stream.Header()

// retrieve trailer 
// `trailer`ä¼šåœ¨rpcè¿”å›çš„æ—¶å€™ï¼Œå³è¿™ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™è¢«å‘é€
// å› æ­¤æ­¤æ—¶è°ƒç”¨`stream.Trailer()`è·å–çš„æ˜¯ç©º
trailer := stream.Trailer()

stream.CloseAndRecv()

// retrieve trailer 
// `trailer`ä¼šåœ¨rpcè¿”å›çš„æ—¶å€™ï¼Œå³è¿™ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™è¢«å‘é€
// å› æ­¤æ­¤æ—¶è°ƒç”¨`stream.Trailer()`æ‰å¯ä»¥è·å–åˆ°å€¼
trailer := stream.Trailer()

ä½¿ç”¨åœºæ™¯
æ—¢ç„¶æˆ‘ä»¬æŠŠmetadataç±»æ¯”æˆHTTP Headerï¼Œé‚£ä¹ˆmetadataçš„ä½¿ç”¨åœºæ™¯ä¹Ÿå¯ä»¥å€Ÿé‰´HTTPçš„Headerã€‚å¦‚ä¼ é€’ç”¨æˆ·tokenè¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œä¼ é€’traceè¿›è¡Œé“¾è·¯è¿½è¸ªç­‰
æ‹¦æˆªå™¨ä¸­çš„metadata
åœ¨æ‹¦æˆªå™¨ä¸­ï¼Œæˆ‘ä»¬ä¸ä½†å¯ä»¥è·å–æˆ–ä¿®æ”¹æ¥æ”¶åˆ°çš„metadataï¼Œç”šè‡³è¿˜å¯ä»¥æˆªå–å¹¶ä¿®æ”¹è¦å‘é€å‡ºå»çš„metadata
è¿˜è®°å¾—æ‹¦æˆªå™¨å¦‚ä½•å®ç°ä¹ˆï¼Ÿå¦‚æœå·²ç»å¿˜äº†å¿«å¿«å›é¡¾ä¸€ä¸‹å§ï¼š
ğŸŒ° ä¸¾ä¸ªä¾‹å­ï¼š
æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯æ‹¦æˆªå™¨ä¸­ä»è¦å‘é€ç»™æœåŠ¡ç«¯çš„metadataä¸­è¯»å–ä¸€ä¸ªæ—¶é—´æˆ³å­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™è¡¥å……è¿™ä¸ªæ—¶é—´æˆ³å­—æ®µ
æ³¨æ„è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªä¸Šæ–‡æ²¡æœ‰æåˆ°çš„FromOutgoingContext(ctx)å‡½æ•°
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func orderUnaryClientInterceptor(ctx context.Context, method string, req, reply interface{},
	cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error {

	var s string

	// è·å–è¦å‘é€ç»™æœåŠ¡ç«¯çš„`metadata`
	md, ok := metadata.FromOutgoingContext(ctx)
	if ok && len(md.Get("time")) > 0 {
		s = md.Get("time")[0]
	} else {
        // å¦‚æœæ²¡æœ‰åˆ™è¡¥å……è¿™ä¸ªæ—¶é—´æˆ³å­—æ®µ
		s = "inter" + strconv.FormatInt(time.Now().UnixNano(), 10)
		ctx = metadata.AppendToOutgoingContext(ctx, "time", s)
	}

	log.Printf("call timestamp: %s", s)

	// Invoking the remote method
	err := invoker(ctx, method, req, reply, cc, opts...)

	return err
}

func main() {
	conn, err := grpc.Dial("127.0.0.1:8009",
		grpc.WithInsecure(),
		grpc.WithChainUnaryInterceptor(
			orderUnaryClientInterceptor,
		),
	)
	if err != nil {
		panic(err)
	}
    
    c := pb.NewOrderManagementClient(conn)

	ctx = metadata.AppendToOutgoingContext(context.Background(), "time",
		"raw"+strconv.FormatInt(time.Now().UnixNano(), 10))

	// RPC using the context with new metadata.
	var header, trailer metadata.MD

	// Add Order
	order := pb.Order{
		Id:          "101",
		Items:       []string{"iPhone XS", "Mac Book Pro"},
		Destination: "San Jose, CA",
		Price:       2300.00,
	}
	res, err := c.AddOrder(ctx, &order)
	if err != nil {
		panic(err)
	}
}

ä»¥ä¸Šçš„æ€è·¯åœ¨serveråŒæ ·é€‚ç”¨ã€‚åŸºäºä»¥ä¸ŠåŸç†æˆ‘ä»¬å¯ä»¥å®ç°é“¾è·¯è¿½è¸ªã€ç”¨æˆ·è®¤è¯ç­‰åŠŸèƒ½
é”™è¯¯ä¿¡æ¯
è¿˜è®°å¾—é”™è¯¯å¤„ç†ä¸€æ–‡ä¸­ç•™ä¸‹çš„é—®é¢˜ä¹ˆï¼šgRPC ä¸­å¦‚ä½•ä¼ é€’é”™è¯¯æ¶ˆæ¯Statusçš„å‘¢ï¼Ÿæ²¡é”™ï¼ä¹Ÿæ˜¯ä½¿ç”¨çš„metadataæˆ–è€…è¯´http2.0 çš„headerã€‚Statusçš„ä¸‰ç§ä¿¡æ¯åˆ†åˆ«ä½¿ç”¨äº†ä¸‰ä¸ªheaderå¤´

Grpc-Status: ä¼ é€’Statusçš„code
Grpc-Message: ä¼ é€’Statusçš„message
Grpc-Status-Details-Bin: ä¼ é€’Statusçš„details

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func (ht *serverHandlerTransport) WriteStatus(s *Stream, st *status.Status) error {
	// ...
		h := ht.rw.Header()
		h.Set("Grpc-Status", fmt.Sprintf("%d", st.Code()))
		if m := st.Message(); m != "" {
			h.Set("Grpc-Message", encodeGrpcMessage(m))
		}

		if p := st.Proto(); p != nil && len(p.Details) > 0 {
			stBytes, err := proto.Marshal(p)
			if err != nil {
				// TODO: return error instead, when callers are able to handle it.
				panic(err)
			}

			h.Set("Grpc-Status-Details-Bin", encodeBinHeader(stBytes))
		}
    // ...
}

æ€»ç»“
ä¸€å¼ å›¾æ€»ç»“ä¸‹æ•´ä¸ªmetadataçš„ä½¿ç”¨æ–¹æ³•

æ¨èé˜…è¯»

å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹-æ‹¦æˆªå™¨
å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹-é”™è¯¯å¤„ç†

å‚è€ƒèµ„æ–™

gRPC ä¸­çš„ Metadata
pkg.go.dev/grpc@v1.44.â€¦
concept of metadata
Documentation/grpc-metadata



ä½œè€…ï¼šå‡‰å‡‰çš„çŸ¥è¯†åº“
é“¾æ¥ï¼šhttps://juejin.cn/post/7202409558592782373
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
