æœ¬ç¯‡ä¸ºã€å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹ã€‘ç³»åˆ—ç¬¬ä¹ç¯‡
ç¬¬ä¸€ç¯‡ï¼šprotobufåŸºç¡€
ç¬¬äºŒç¯‡ï¼šé€šä¿¡æ¨¡å¼
ç¬¬ä¸‰ç¯‡ï¼šæ‹¦æˆªå™¨
ç¬¬å››ç¯‡ï¼šé”™è¯¯å¤„ç†
ç¬¬äº”ç¯‡ï¼šmetadata
ç¬¬å…­ç¯‡ï¼šè¶…æ—¶æ§åˆ¶
ç¬¬ä¸ƒç¯‡ï¼šå®‰å…¨
ç¬¬å…«ç¯‡ï¼šç”¨æˆ·è®¤è¯
ç¬¬ä¹ç¯‡ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ ğŸ‘ˆ
æœ¬ç³»åˆ—å°†æŒç»­æ›´æ–°ï¼Œæ¬¢è¿å…³æ³¨ ğŸ‘ è·å–å®æ—¶é€šçŸ¥

å¯¹äºä¸€ä¸ªå®¢æˆ·ç«¯åˆ›å»ºè¯·æ±‚çš„è¿‡ç¨‹
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç conn, err := grpc.Dial("example:///8009", grpc.WithInsecure())
if err != nil {
  panic(err)
}


gRPCå®¢æˆ·ç«¯é€šè¿‡æœåŠ¡å‘ç°è§£æè¯·æ±‚ï¼Œå°†åç§°è§£æä¸ºä¸€ä¸ªæˆ–å¤šä¸ªIPåœ°å€ï¼Œä»¥åŠæœåŠ¡é…ç½®
å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥çš„æœåŠ¡é…ç½®ã€ipåˆ—è¡¨ã€å®ä¾‹åŒ–è´Ÿè½½å‡è¡¡ç­–ç•¥
è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸ºæ¯ä¸ªæœåŠ¡å™¨åœ°å€åˆ›å»ºä¸€ä¸ªå­é€šé“ï¼ˆchannelï¼‰ï¼Œå¹¶ç›‘æµ‹æ¯ä¸€ä¸ªå­é€šé“çŠ¶æ€
å½“æœ‰rpcè¯·æ±‚æ—¶ï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥å†³å®šé‚£ä¸ªå­é€šé“å³gRPCæœåŠ¡å™¨å°†æ¥æ”¶è¯·æ±‚ï¼Œå½“å¯ç”¨æœåŠ¡å™¨ä¸ºç©ºæ—¶å®¢æˆ·ç«¯çš„è¯·æ±‚å°†è¢«é˜»å¡

gRPCå®˜æ–¹æä¾›äº†åŸºæœ¬çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡é€»è¾‘ï¼Œå¹¶æä¾›äº†æ¥å£ä¾›æ‰©å±•ç”¨äºå¼€å‘è‡ªå®šä¹‰çš„æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡
æœåŠ¡å‘ç°
ç”¨é€šä¿—æ˜“æ‡‚çš„æ–¹å¼æ¥è§£é‡Šä¸‹ä»€ä¹ˆæ˜¯æœåŠ¡å‘ç°ã€‚é€šå¸¸æƒ…å†µä¸‹å®¢æˆ·ç«¯éœ€è¦çŸ¥é“æœåŠ¡ç«¯çš„IP+ç«¯å£å·æ‰èƒ½å»ºç«‹è¿æ¥ï¼Œä½†æœåŠ¡ç«¯çš„IPå’Œç«¯å£å·å¹¶ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“è®°å¿†ã€‚è¿˜æœ‰æ›´é‡è¦çš„ï¼Œåœ¨äº‘éƒ¨ç½²çš„ç¯å¢ƒä¸­ï¼ŒæœåŠ¡ç«¯çš„IPå’Œç«¯å£å¯èƒ½éšæ—¶ä¼šå‘ç”Ÿå˜åŒ–ã€‚
æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»™æŸä¸€ä¸ªæœåŠ¡èµ·ä¸€ä¸ªåå­—ï¼Œå®¢æˆ·ç«¯é€šè¿‡åå­—åˆ›å»ºä¸æœåŠ¡ç«¯çš„è¿æ¥ï¼Œå®¢æˆ·ç«¯åº•å±‚ä½¿ç”¨æœåŠ¡å‘ç°ç³»ç»Ÿï¼Œè§£æè¿™ä¸ªåå­—æ¥è·å–çœŸæ­£çš„IPå’Œç«¯å£ï¼Œå¹¶åœ¨æœåŠ¡ç«¯çš„IPå’Œç«¯å£å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡æ–°å»ºç«‹è¿æ¥ã€‚è¿™æ ·çš„ç³»ç»Ÿé€šå¸¸ä¹Ÿä¼šè¢«å«åšname-systemï¼ˆåå­—æœåŠ¡ï¼‰
gRPC ä¸­çš„é»˜è®¤name-systemæ˜¯ DNSï¼ŒåŒæ—¶åœ¨å®¢æˆ·ç«¯ä»¥æ’ä»¶å½¢å¼æä¾›äº†è‡ªå®šä¹‰name-systemçš„æœºåˆ¶ã€‚
åå­—æ ¼å¼
gRPCé‡‡ç”¨çš„åå­—æ ¼å¼éµå¾ªçš„RFC 3986ä¸­å®šä¹‰çš„URIè¯­æ³•
ini ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç scheme:[//[user[:password]@]host[:port]][/path][?query][#fragment]

ä¾‹å¦‚

gRPCå…³æ³¨å…¶ä¸­ä¸¤éƒ¨åˆ†


URI schemeï¼šç¬¬ä¸€ä¸ª:å‰é¢çš„æ ‡è¯†ã€‚å¯¹äºgRPCå®¢æˆ·ç«¯æ¥è¯´ï¼Œå®ƒæŒ‡ç¤ºè¦ä½¿ç”¨çš„æœåŠ¡å‘ç°è§£æå™¨ï¼Œå¦‚æœæœªæŒ‡å®šå‰ç¼€æˆ–æ–¹æ¡ˆæœªçŸ¥ï¼Œåˆ™é»˜è®¤ä½¿ç”¨DNSæ–¹æ¡ˆ


URI pathï¼š æŒ‡ç¤ºè¦è§£æçš„åå­—


å¤§éƒ¨åˆ†gRPCå®ç°é»˜è®¤æ”¯æŒä»¥ä¸‹çš„URI schemes


dns:[//authority/]host[:port] -- DNS (default)


unix:path, unix://absolute_path -- Unix domain sockets (Unix systems only)


unix-abstract:abstract_path -- Unix domain socket in abstract namespace (Unix systems only)


æœåŠ¡çš„æœåŠ¡æ³¨å†Œ
å¦‚æœgRPCæœåŠ¡ç«¯çš„åœ°å€æ˜¯é™æ€çš„ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯æœåŠ¡å‘ç°æ—¶ç›´æ¥è§£æä¸ºé™æ€çš„åœ°å€
å¦‚æœgRPCæœåŠ¡ç«¯çš„åœ°å€æ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©

è‡ªæ³¨å†Œï¼šå½“gRPCçš„æœåŠ¡å¯åŠ¨åï¼Œå‘ä¸€ä¸ªé›†ä¸­çš„æ³¨å†Œä¸­å¿ƒè¿›è¡Œæ³¨å†Œ
å¹³å°çš„æœåŠ¡å‘ç°ï¼šä½¿ç”¨k8så¹³å°æ—¶ï¼Œå¹³å°ä¼šæ„ŸçŸ¥gPRCå®ä¾‹çš„å˜åŒ–

å…³äºæœåŠ¡æ³¨å†Œè¿™é‡Œä¸åœ¨åšæ›´å¤šä»‹ç»äº†
å®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°
è‡ªå®šä¹‰æœåŠ¡å‘ç°éœ€è¦åœ¨å®¢æˆ·ç«¯å¯åŠ¨å‰ï¼Œæ³¨å†Œä¸€ä¸ªæœåŠ¡è§£æå™¨ï¼ˆResolveï¼‰
Golangä¸­ä½¿ç”¨google.golang.org/grpc/resolver.Register(resolver.Builder)æ³¨å†Œï¼Œè¿™ä¸ªå‡½æ•°ä¸æ˜¯ç›´æ¥æ¥æ”¶ä¸€ä¸ªè§£æå™¨ï¼Œè€Œæ˜¯ä½¿ç”¨å·¥å‚æ¨¡å¼æ¥æ”¶ä¸€ä¸ªè§£æå™¨çš„æ„é€ å™¨
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç type Builder interface {
	// Build creates a new resolver for the given target.
	//
	// gRPC dial calls Build synchronously, and fails if the returned error is
	// not nil.
	Build(target Target, cc ClientConn, opts BuildOptions) (Resolver, error)
	// Scheme returns the scheme supported by this resolver.
	// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.
	Scheme() string
}

âœ¨ Scheme()éœ€è¦è¿”å›çš„å°±æ˜¯åå­—æ ¼å¼ä¸­æåˆ°çš„URI scheme
âœ¨ Build(...)éœ€è¦è¿”å›ä¸€ä¸ªæœåŠ¡å‘ç°è§£æå™¨google.golang.org/grpc/resolver.Resolver
âœ¨âœ¨cc ClientConnä»£è¡¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥ï¼Œå…¶æ‹¥æœ‰çš„cc.UpdateState(State) errorå¯ä»¥è®©æˆ‘ä»¬æ›´æ–°é“¾æ¥çš„çŠ¶æ€
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç type Resolver interface {
	// ResolveNow will be called by gRPC to try to resolve the target name
	// again. It's just a hint, resolver can ignore this if it's not necessary.
	//
	// It could be called multiple times concurrently.
  // ResolveNow å°è¯•å†ä¸€æ¬¡å¯¹åŸŸåè¿›è¡Œè§£æï¼Œåœ¨ä¸ªäººå®è·µä¸­ï¼ŒæœåŠ¡ç«¯è¿›ç¨‹æŒ‚æ‰ä¼šè§¦å‘è¯¥è°ƒç”¨
	ResolveNow(ResolveNowOptions)
  // Close closes the resolver.
  // èµ„æºé‡Šæ”¾ã€‚
	Close()
}

è§£æå™¨éœ€è¦æœ‰èƒ½åŠ›ä»æ³¨å†Œä¸­å¿ƒè·å–è§£æç»“æœï¼Œå¹¶æ›´æ–°å®¢æˆ·ç«¯ä¸­è¿æ¥(cc ClientConn)çš„ä¿¡æ¯ã€‚è¿˜å¯ä»¥æŒç»­watchä¸€ä¸ªåå­—çš„è§£æç»“æœï¼Œå®æ—¶çš„æ›´æ–°å®¢æˆ·ç«¯ä¸­è¿æ¥çš„ä¿¡æ¯

è§£æå‡ºæ¥çš„åœ°å€åˆ—è¡¨ï¼ˆåŒ…å«ipå’Œportï¼‰
é’ˆå¯¹è¿æ¥çš„æœåŠ¡é…ç½®ï¼Œå¦‚è´Ÿè½½å‡è¡¡ç­‰ï¼Œæ¥æƒ³è¦†ç›–å…¨å±€çš„è´Ÿè´£å‡è¡¡é…ç½®
æ¯ä¸€ä¸ªåœ°å€å¯ä»¥åŒ…å«ä¸€ç³»åˆ—çš„å±æ€§ï¼ˆkvï¼‰ï¼Œä»–ä»¬å¯ä»¥ç”¨æ¥æ”¯æŒåç»­çš„è´Ÿè½½å‡è¡¡ç­–ç•¥

ç¤ºä¾‹ä»£ç 
gRPC resolver åŸç†
ğŸŒ² åœ¨ init() é˜¶æ®µæ—¶

åˆ›å»ºå¹¶æ³¨å†ŒBuilder å®ä¾‹ï¼Œå°†å…¶æ³¨å†Œåˆ° grpc å†…éƒ¨çš„ resolveBuilder è¡¨ä¸­ï¼ˆå…¶å®æ˜¯ä¸€ä¸ªå…¨å±€ mapï¼Œkey ä¸ºåè®®åï¼›value ä¸ºæ„é€ çš„ resolveBuilderï¼‰

ğŸŒ² å®¢æˆ·ç«¯å¯åŠ¨æ—¶é€šè¿‡è‡ªå®šä¹‰Dail()æ–¹æ³•æ„é€ grpc.ClientConnå•ä¾‹


grpc.DialContext() æ–¹æ³•å†…éƒ¨è§£æ URIï¼Œåˆ†æåè®®ç±»å‹ï¼Œå¹¶ä» resolveBuilder è¡¨ä¸­æŸ¥æ‰¾åè®®å¯¹åº”çš„ resolverBuilder


å°†åœ°å€ä½œä¸º Target ã€connå•ä¾‹ä½œä¸ºresolver.ClientConnå‚æ•°è°ƒç”¨ resolver.Build æ–¹æ³•å®ä¾‹åŒ–å‡º Resolver


ç”¨æˆ· Resolverå®ç°ä¸­è°ƒç”¨ cc.UpdateState ä¼ å…¥ State.Addresses åœ°å€ï¼ŒgRPCä½¿ç”¨è¿™ä¸ªåœ°å€å»ºç«‹è¿æ¥ï¼Œä¼ å…¥State.ServiceConfigï¼ŒgRPCä½¿ç”¨è¿™ä»½æœåŠ¡é…ç½®è¦†ç›–é»˜è®¤é…ç½®



ä»£ç 
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç # builder.go
package resolver

import "google.golang.org/grpc/resolver"

var _ resolver.Builder = Builder{}

type Builder struct {
	addrsStore map[string][]string
}

func NewResolverBuilder(addrsStore map[string][]string) *Builder {
	return &Builder{addrsStore: addrsStore}
}

func (b Builder) Build(target resolver.Target, cc resolver.ClientConn, opts resolver.BuildOptions) (resolver.Resolver, error) {
	r := &Resolver{
		target:     target,
		cc:         cc,
		addrsStore: b.addrsStore,
	}
	r.Start()
	return r, nil
}

func (b Builder) Scheme() string {
	return "example"
}

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç # resolver.go
package resolver

import (
	"google.golang.org/grpc/resolver"
)

var _ resolver.Resolver = &Resolver{}

// impl google.golang.org/grpc/resolver.Resolver
type Resolver struct {
	target resolver.Target
	cc     resolver.ClientConn

	addrsStore map[string][]string
}

func (r *Resolver) Start() {
	// åœ¨é™æ€è·¯ç”±è¡¨ä¸­æŸ¥è¯¢æ­¤ Endpoint å¯¹åº” addrs
	var addrs []resolver.Address
	for _, addr := range r.addrsStore[r.target.URL.Opaque] {
		addrs = append(addrs, resolver.Address{Addr: addr})
	}

	r.cc.UpdateState(resolver.State{
		Addresses: addrs,
    // è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸ºround_robin
		ServiceConfig: r.cc.ParseServiceConfig(
    `{"loadBalancingPolicy":"round_robin"}`),
	})
}

func (r *Resolver) ResolveNow(resolver.ResolveNowOptions) {

}

func (r *Resolver) Close() {

}

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç # main.go
package main

import (
	"context"
	"log"

	rs "github.com/liangwt/note/grpc/name_resolver_lb_example/client/resolver"
	pb "github.com/liangwt/note/grpc/name_resolver_lb_example/ecommerce"
	"google.golang.org/grpc"
	"google.golang.org/grpc/resolver"
)

func main() {
	resolver.Register(rs.NewResolverBuilder(map[string][]string{
		"cluster@callee": {
			"127.0.0.1:8009",
		},
	}))

	conn, err := grpc.Dial("example:///cluster@callee", grpc.WithInsecure())
	if err != nil {
		panic(err)
	}
  
	// ...
}

è´Ÿè½½å‡è¡¡
åŒæ ·æ¥é€šä¿—æ˜“æ‡‚çš„è§£é‡Šä¸‹ä»€ä¹ˆè´Ÿè½½å‡è¡¡ã€‚ä¸ºäº†æé«˜ç³»ç»Ÿçš„è´Ÿè½½èƒ½åŠ›å’Œç¨³å®šæ€§ï¼Œæˆ‘ä»¬çš„æœåŠ¡ç«¯å¾€å¾€å…·æœ‰å¤šå°æœåŠ¡å™¨ï¼Œè´Ÿè½½å‡è¡¡çš„ç›®çš„å°±æ˜¯å¸Œæœ›è¯·æ±‚èƒ½åˆ†æ•£åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°æœåŠ¡å™¨çš„ç®—æ³•å°±æ˜¯è´Ÿè½½å‡è¡¡çš„ç­–ç•¥ï¼Œå¸¸è§çš„è½®å¾ªã€åŠ æƒè½®è¯¢ç­‰
è´Ÿè½½å‡è¡¡å™¨è¦åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´é€‰æ‹©ï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹è´Ÿè½½å‡è¡¡å™¨æ˜¯å…·å¤‡æœåŠ¡å‘ç°çš„èƒ½åŠ›çš„
æ ¹æ®è´Ÿè½½å‡è¡¡å®ç°æ‰€åœ¨çš„ä½ç½®ä¸åŒï¼Œé€šå¸¸å¯åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§è§£å†³æ–¹æ¡ˆï¼š
1ã€é›†ä¸­å¼è´Ÿè½½å‡è¡¡ï¼ˆProxy Modelï¼‰
åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´æœ‰ä¸€ä¸ªç‹¬ç«‹çš„LBï¼Œé€šå¸¸æ˜¯ä¸“é—¨çš„ç¡¬ä»¶è®¾å¤‡å¦‚ F5ï¼Œæˆ–è€…åŸºäºè½¯ä»¶å¦‚ LVSï¼ŒHAproxyï¼ŒNginxç­‰å®ç°ã€‚LBä½¿ç”¨è´Ÿè½½å‡è¡¡ç­–ç•¥å°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡æœåŠ¡
å› ä¸ºæ‰€æœ‰æœåŠ¡è°ƒç”¨æµé‡éƒ½ç»è¿‡LBï¼Œå½“æœåŠ¡æ•°é‡å’Œè°ƒç”¨é‡å¤§çš„æ—¶å€™ï¼ŒLBå®¹æ˜“æˆä¸ºç“¶é¢ˆï¼›ä¸€æ—¦LBå‘ç”Ÿæ•…éšœå½±å“æ•´ä¸ªç³»ç»Ÿï¼›å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ä¹‹é—´å¢åŠ äº†ä¸€çº§ï¼Œæœ‰ä¸€å®šæ€§èƒ½å¼€é”€

2ã€å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆBalancing-aware Clientï¼‰
å®¢æˆ·ç«¯è´Ÿè½½å°†LBçš„åŠŸèƒ½é›†æˆåˆ°å®¢æˆ·ç«¯è¿›ç¨‹é‡Œï¼Œç„¶åä½¿ç”¨è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©ä¸€ä¸ªç›®æ ‡æœåŠ¡åœ°å€ï¼Œå‘ç›®æ ‡æœåŠ¡å‘èµ·è¯·æ±‚ã€‚LBèƒ½åŠ›è¢«åˆ†æ•£åˆ°æ¯ä¸€ä¸ªæœåŠ¡æ¶ˆè´¹è€…çš„è¿›ç¨‹å†…éƒ¨ï¼ŒåŒæ—¶æœåŠ¡æ¶ˆè´¹æ–¹å’ŒæœåŠ¡æä¾›æ–¹ä¹‹é—´æ˜¯ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰é¢å¤–å¼€é”€ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ã€‚
ä½†å¦‚æœæœ‰å¤šç§ä¸åŒçš„è¯­è¨€æ ˆï¼Œå°±è¦é…åˆå¼€å‘å¤šç§ä¸åŒçš„å®¢æˆ·ç«¯ï¼Œæœ‰ä¸€å®šçš„ç ”å‘å’Œç»´æŠ¤æˆæœ¬ï¼›åç»­å¦‚æœè¦å¯¹å®¢æˆ·åº“è¿›è¡Œå‡çº§ï¼ŒåŠ¿å¿…è¦æ±‚æœåŠ¡è°ƒç”¨æ–¹ä¿®æ”¹ä»£ç å¹¶é‡æ–°å‘å¸ƒï¼Œå‡çº§è¾ƒå¤æ‚ã€‚

3ã€ç‹¬ç«‹è´Ÿè½½å‡è¡¡è¿›ç¨‹ï¼ˆExternal Load Balancing Serviceï¼‰
å°†LBä»è¿›ç¨‹å†…ç§»å‡ºæ¥ï¼Œå˜æˆä¸»æœºä¸Šçš„ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ã€‚ä¸»æœºä¸Šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªæœåŠ¡è¦è®¿é—®ç›®æ ‡æœåŠ¡æ—¶ï¼Œä»–ä»¬éƒ½é€šè¿‡åŒä¸€ä¸»æœºä¸Šçš„ç‹¬ç«‹LBè¿›ç¨‹åšè´Ÿè½½å‡è¡¡
æ­¤æ–¹æ¡ˆæœ‰ä¸¤ç§æ¨¡å¼
ç¬¬ä¸€ç§æ˜¯ç›´æ¥ç”±LBè¿›è¡Œè½¬å‘è¯·æ±‚ï¼Œè¢«ç§°ä¸ºsidecaræ–¹æ¡ˆ
ç¬¬äºŒç§æ˜¯ä»LBè·å–åˆ°IPåä¾æ—§ç”±å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ŒgRPCæ›¾ç»æ”¯æŒè¿‡æ­¤æ–¹æ¡ˆå«lookasideæ–¹æ¡ˆï¼Œç›®å‰å·²åºŸå¼ƒ
è¯¥æ–¹æ¡ˆä¹Ÿæ˜¯ä¸€ç§åˆ†å¸ƒå¼æ–¹æ¡ˆæ²¡æœ‰å•ç‚¹é—®é¢˜ï¼Œä¸€ä¸ªLBè¿›ç¨‹æŒ‚äº†åªå½±å“è¯¥ä¸»æœºä¸Šçš„å®¢æˆ·ç«¯ï¼›å®¢æˆ·ç«¯å’ŒLBä¹‹é—´æ˜¯æœ¬åœ°è°ƒç”¨è°ƒç”¨æ€§èƒ½å¥½ï¼›åŒæ—¶è¯¥æ–¹æ¡ˆè¿˜ç®€åŒ–äº†å®¢æˆ·ç«¯ï¼Œä¸éœ€è¦ä¸ºä¸åŒè¯­è¨€å¼€å‘å®¢æˆ·åº“ï¼ŒLBçš„å‡çº§ä¸éœ€è¦æœåŠ¡è°ƒç”¨æ–¹æ”¹ä»£ç ã€‚ è¯¥æ–¹æ¡ˆä¸»è¦é—®é¢˜ï¼šéƒ¨ç½²è¾ƒå¤æ‚ï¼Œç¯èŠ‚å¤šï¼Œå‡ºé”™è°ƒè¯•æ’æŸ¥é—®é¢˜ä¸æ–¹ä¾¿

gRPCçš„è´Ÿè½½å‡è¡¡
ä¸Šæ–‡ä»‹ç»çš„ä¸‰ç§è´Ÿè½½å‡è¡¡æ–¹å¼ï¼Œé›†ä¸­å¼è´Ÿè½½å‡è¡¡å’ŒgRPCæ— å…³ï¼Œå±äºå¤–éƒ¨çš„åŸºç¡€è®¾æ–½ï¼Œå› æ­¤æˆ‘ä»¬ä¸å†ä»‹ç»
gRPCä¸­çš„è´Ÿè½½å¹³è¡¡æ˜¯ä»¥æ¯æ¬¡è°ƒç”¨ä¸ºåŸºç¡€ï¼Œè€Œä¸æ˜¯ä»¥æ¯ä¸ªè¿æ¥ä¸ºåŸºç¡€ã€‚æ¢å¥è¯è¯´ï¼Œå³ä½¿æ‰€æœ‰çš„è¯·æ±‚éƒ½æ¥è‡ªä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®ƒä»èƒ½åœ¨æ‰€æœ‰çš„æœåŠ¡å™¨ä¸Šå®ç°è´Ÿè½½å¹³è¡¡
gRPCç›®å‰å†…ç½®å››ç§ç­–ç•¥
ğŸŒ² pick_firstï¼šé»˜è®¤ç­–ç•¥ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
ğŸŒ² round_robinï¼šè½®è¯¢
ä½¿ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡å™¨å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥å³å¯ã€‚

âš ï¸ æ³¨æ„
æ—§ç‰ˆæœ¬gRPCä½¿ç”¨ grpc.WithBalancerName("round_robin"),å·²ç»è¢«åºŸå¼ƒï¼Œä½¿ç”¨grpc.WithDefaultServiceConfigã€‚
grpc.WithDefaultServiceConfigå¯ä»¥è¢«ä¸Šæ–‡æœåŠ¡å‘ç°ä¸­æåˆ°çš„cc.UpdateState(State) errorè¦†ç›–é…ç½®

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç 	conn, err := grpc.Dial("example:///cluster@callee",
		grpc.WithInsecure(),
		grpc.WithDefaultServiceConfig(
			`{"loadBalancingPolicy":"round_robin"}`,
		),
	)

ğŸŒ² grpclbï¼šå·²åºŸå¼ƒ
å®ƒå±äºä¸Šæ–‡ä»‹ç»çš„è´Ÿè½½å‡è¡¡ä¸­ç‹¬ç«‹è´Ÿè½½å‡è¡¡è¿›ç¨‹ç¬¬äºŒç§ã€‚ä¸å¿…ç›´æ¥åœ¨å®¢æˆ·ç«¯ä¸­æ·»åŠ æ–°çš„LBç­–ç•¥ï¼Œè€Œåªå®ç°è¯¸å¦‚round-robinä¹‹ç±»çš„ç®€å•ç®—æ³•ï¼Œä»»ä½•æ›´å¤æ‚çš„ç®—æ³•éƒ½å°†ç”±lookasideè´Ÿè½½å¹³è¡¡å™¨æä¾›

ğŸŒ² xDS
å¦‚æœæ¥è§¦è¿‡servicemeshé‚£ä¹ˆå¯¹xDSå¹¶ä¸ä¼šé™Œç”Ÿï¼ŒxDS æœ¬èº«æ˜¯Envoyä¸­çš„æ¦‚å¿µï¼Œç°åœ¨å·²ç»å‘å±•ä¸ºç”¨äºé…ç½®å„ç§æ•°æ®å¹³é¢è½¯ä»¶çš„æ ‡å‡†ï¼Œæœ€æ–°ç‰ˆæœ¬çš„gRPCå·²ç»æ”¯æŒxDSã€‚ä¸åŒäºå•çº¯çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ŒxDSåœ¨gRPCåŒ…å«äº†æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„æ¦‚å¿µ
è¿™é‡Œç®€å•çš„ç†è§£ä¸‹xDSï¼Œæœ¬è´¨ä¸ŠxDSå°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„åè®®
å®ƒè§„å®šäº†xDSå®¢æˆ·ç«¯å’ŒxDSæœåŠ¡ç«¯çš„äº¤äº’æµç¨‹ï¼Œå³APIè°ƒç”¨çš„é¡ºåº
æˆ‘ä»¬åœ¨xDS serverå®ç°æœåŠ¡å‘ç°ï¼Œé…ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ç­‰ç­‰ï¼Œæ”¯æŒxDSçš„å®¢æˆ·ç«¯è¿æ¥åˆ°xDS serverå¹¶é€šè¿‡xDS apiæ¥è·å–å„ç§éœ€è¦çš„æ•°æ®å’Œé…ç½®
xDSä¸»è¦åº”ç”¨äºservicemeshä¸­ï¼Œåœ¨meshä¸­ç”±sidecarè¿æ¥åˆ°xDS serverè¿›è¡Œæ•°æ®äº¤äº’ï¼ŒåŒæ—¶ç”±sidecaræ¥æ§åˆ¶æµé‡çš„åˆ†å‘ã€‚ä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ç‹¬ç«‹è´Ÿè½½å‡è¡¡è¿›ç¨‹çš„ç¬¬ä¸€ç§æ¨¡å¼

gRPCä½¿ç”¨xDSæ˜¯ä¸€ç§æ— proxyçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æ–¹æ¡ˆã€‚å¯¹æ¯”Meshæ–¹æ¡ˆï¼Œæ€§èƒ½æ›´å¥½ã€‚æˆ‘ä»¬æŠŠservicemeshçš„è´Ÿè½½å‡è¡¡å’Œgrpcçš„xdsè´Ÿè½½å‡è¡¡æ”¾åœ¨ä¸€èµ·æ„Ÿå—ä¸‹åŒºåˆ«

ğŸ“– è¿™æ„å‘³ç€ï¼ŒgrpclbåºŸå¼ƒåï¼ŒgRPCå†…ç½®çš„pick_firstã€round_robinã€xDSä¸‰ç§æ¨¡å¼éƒ½å±äºå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡æ¨¡å¼ã€‚pick_firstã€round_robinæ˜¯å•çº¯çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼›xDSåŒ…å«äº†æœåŠ¡å‘ç°ç­‰ä¸€ç³»åˆ—èƒ½åŠ›ï¼Œå¹¶ä¸”è¿˜åœ¨ä¸æ–­æ‹“å±•ä¸­ï¼Œè€Œæˆ‘ä»¬æ§åˆ¶gRPCçš„è¡Œä¸ºä¹Ÿè¢«è½¬ç§»åˆ°äº†xDS serverä¸Šäº†ã€‚
xDSæ¨¡å¼çš„ä½¿ç”¨
xDSå†…å®¹è¾ƒå¤šï¼Œåˆæ¯”è¾ƒæ–°ï¼Œå•ç‹¬å¼€ä¸ªç« èŠ‚ä»‹ç»ä¸‹xDSçš„ä½¿ç”¨
gRPC xDSæ¶æ„ä¸­å‡ºç°äº†ä¸‰ä¸ªæœåŠ¡

xDS serverï¼šå®ƒæ˜¯æˆ‘ä»¬çš„æ§åˆ¶é¢
gRPC clientï¼šå®ƒæ—¢æ˜¯gRPCæœåŠ¡çš„å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ä¹Ÿæ˜¯xDSçš„å®¢æˆ·ç«¯
gRPC serverï¼šå®ƒæ˜¯gRPCæœåŠ¡çš„æœåŠ¡ç«¯ï¼Œå®ƒéœ€è¦å…·å¤‡è¢«xDS serverå‘ç°çš„èƒ½åŠ›

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Envoy go-control-planeåº“æ¥å®ç°xDS serverï¼Œè¿™éƒ¨åˆ†çš„å¼€å‘ç±»ä¼¼äºservicemeshï¼Œå°±ä¸ä»‹ç»å¤ªå¤šäº†ï¼Œå¦‚æœä½äºk8så¹³å°å†…å¯ä»¥å‚è€ƒä¸‹istioä¸­æ§åˆ¶é¢çš„å®ç°
gRPC serveréœ€è¦è‡ªæ³¨å†Œæˆ–è€…æ‰˜ç®¡åˆ°k8så¹³å°ï¼Œå¦‚æœæ‰˜ç®¡åˆ°k8såˆ™å¯ä»¥ç»§ç»­å‚è€ƒistioä¸­æ§åˆ¶é¢çš„å®ç°
å› ä¸ºxDSä¹ŸåŒ…å«äº†æœåŠ¡å‘ç°çš„éƒ¨åˆ†ï¼Œå› æ­¤å¯¹äºclientæ¥è¯´ç¬¬ä¸€æ­¥éœ€è¦å…ˆå¼€å‘è‡ªå®šä¹‰çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡é…ç½®ã€‚å¹¸è¿çš„æ˜¯gRPCå®˜æ–¹å·²ç»ä¸ºæˆ‘ä»¬å¼€å‘äº†å¯¹åº”å®ç°ï¼Œåªéœ€è¦å¼•å…¥åŒ…å³å¯ï¼Œåœ¨inité˜¶æ®µä¼šæ³¨å†ŒxDSçš„è§£æå™¨å’Œè´Ÿè½½å‡è¡¡å™¨
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç _ "google.golang.org/grpc/xds" // To install the xds resolvers and balancers.

éšååªéœ€è¦æŠŠgRPC clientè¿æ¥åˆ°xDs serverå³å¯ï¼Œè¿™éƒ¨åˆ†ä¸éxDSå¹¶æ— ä¸åŒã€‚åªæ˜¯ç›®æ ‡æœåŠ¡çš„åœ°å€çš„URI schemeä¸ºxds
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç conn, err := grpc.Dial("xds:///localhost:50051", grpc.WithTransportCredentials(creds))
if err != nil {
  panic(err)
}

ctx, cancelFn := context.WithCancel(context.Background())
defer cancelFn()

c := pb.NewOrderManagementClient(conn)
res, err := c.AddOrder(ctx, &order)

å®Œæ•´ä»£ç å¯ä»¥å‚è€ƒï¼šgithub.com/grpc/grpc-gâ€¦
è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨
è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨éœ€è¦ä½¿ç”¨google.golang.org/grpc/balancer.Registeræå‰æ³¨å†Œï¼Œæ­¤å‡½æ•°å’ŒæœåŠ¡å‘ç°ä¸€æ ·æ¥å—å·¥å‚å‡½æ•°
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // Builder creates a balancer.
type Builder interface {
	// Build creates a new balancer with the ClientConn.
	Build(cc ClientConn, opts BuildOptions) Balancer
	// Name returns the name of balancers built by this builder.
	// It will be used to pick balancers (for example in service config).
	Name() string
}

âœ¨ Name()æ˜¯è´Ÿè½½å‡è¡¡ç­–ç•¥çš„åå­—
âœ¨ Build(...)éœ€è¦è¿”å›è´Ÿè½½å‡è¡¡å™¨
âœ¨âœ¨ cc ClientConnä»£è¡¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥ï¼Œå…¶æ‹¥æœ‰ä¸€ç³»åˆ—å‡½æ•°å¯ä»¥è®©æˆ‘ä»¬æ›´æ–°é“¾æ¥çš„çŠ¶æ€
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç type Balancer interface {
	// UpdateClientConnState is called by gRPC when the state of the ClientConn
	// changes.  If the error returned is ErrBadResolverState, the ClientConn
	// will begin calling ResolveNow on the active name resolver with
	// exponential backoff until a subsequent call to UpdateClientConnState
	// returns a nil error.  Any other errors are currently ignored.
	UpdateClientConnState(ClientConnState) error
	// ResolverError is called by gRPC when the name resolver reports an error.
	ResolverError(error)
	// UpdateSubConnState is called by gRPC when the state of a SubConn
	// changes.
	UpdateSubConnState(SubConn, SubConnState)
	// Close closes the balancer. The balancer is not required to call
	// ClientConn.RemoveSubConn for its existing SubConns.
	Close()
}

è´Ÿè½½å‡è¡¡å™¨éœ€è¦å®ç°ä¸€ç³»åˆ—çš„å‡½æ•°ç”¨äºgRPCåœ¨ä¸åŒåœºæ™¯ä¸‹è°ƒç”¨
ç±»RRç®—æ³•è´Ÿè½½å‡è¡¡å™¨
å¦‚æœè¦å®ç°ä¸€ä¸ªç±»round_robinçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ŒgRPCå®˜æ–¹å®ç°æä¾›äº†ä¸€ä¸ªbaseBuilderï¼Œå®ƒå·²ç»å®ç°äº†å¤§éƒ¨Balanceræ¥å£ï¼Œå¯ä»¥å¤§å¹…ç®€åŒ–äº†æˆ‘ä»¬åˆ›å»ºRRç­–ç•¥çš„é€»è¾‘ã€‚ä½¿ç”¨google.golang.org/grpc/balancer/base.NewBalancerBuilderåˆ›å»ºè´Ÿè½½å‡è¡¡çš„å·¥å‚
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç func NewBalancerBuilder(name string, pb PickerBuilder, config Config) balancer.Builder 


name stringè´Ÿè½½å‡è¡¡å™¨çš„åå­—
pb PickerBuilderæ˜¯æˆ‘ä»¬è¦å®ç°çš„è´Ÿè½½å‡è¡¡ç­–ç•¥é€»è¾‘çš„åœ°æ–¹
config Configå¯ä»¥é…ç½®æ˜¯å¦è¦è¿›è¡Œå¥åº·æ£€æŸ¥

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // PickerBuilder creates balancer.Picker.
type PickerBuilder interface {
	// Build returns a picker that will be used by gRPC to pick a SubConn.
	Build(info PickerBuildInfo) balancer.Picker
}

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç type Picker interface {
  // å­è¿æ¥é€‰æ‹©
	Pick(info PickInfo) (PickResult, error)
}

äºæ˜¯å€ŸåŠ©base.NewBalancerBuilderæˆ‘ä»¬ä»…éœ€è¦å®ç°Pickerä¸€ä¸ªå‡½æ•°å³å¯å®ç°ç±»RRçš„è´Ÿè½½å‡è¡¡ç­–ç•¥äº†
ä»£ç 
åˆ©ç”¨Pickeræ¥å£æ¥å®ç°ä¸€ä¸ªéšæœºé€‰æ‹©ç­–ç•¥
go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç # builder.go
package balancer

import (
	"google.golang.org/grpc/balancer"
	"google.golang.org/grpc/balancer/base"
)

var _ base.PickerBuilder = &Builder{}

type Builder struct {
}

func NewBalancerBuilder() balancer.Builder {
	return base.NewBalancerBuilder("random_picker", &Builder{}, base.Config{HealthCheck: true})
}

func (b *Builder) Build(info base.PickerBuildInfo) balancer.Picker {
	if len(info.ReadySCs) == 0 {
		return base.NewErrPicker(balancer.ErrNoSubConnAvailable)
	}

	var scs []balancer.SubConn
	for subConn := range info.ReadySCs {
		scs = append(scs, subConn)
	}

	return &Picker{
		subConns: scs,
	}
}

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç // picker.go
package balancer

import (
	"math/rand"

	"google.golang.org/grpc/balancer"
)

var _ balancer.Picker = &Picker{}

type Picker struct {
	subConns []balancer.SubConn
}

func (p *Picker) Pick(info balancer.PickInfo) (balancer.PickResult, error) {
	index := rand.Intn(len(p.subConns))
	sc := p.subConns[index]
	return balancer.PickResult{SubConn: sc}, nil
}

go ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç #client.go
package main

import (
	"context"
	"log"

	bl "github.com/liangwt/note/grpc/name_resolver_lb_example/client/balancer"
	rs "github.com/liangwt/note/grpc/name_resolver_lb_example/client/resolver"
	pb "github.com/liangwt/note/grpc/name_resolver_lb_example/ecommerce"
	"google.golang.org/grpc"
	"google.golang.org/grpc/balancer"
	"google.golang.org/grpc/resolver"
)

func main() {
	resolver.Register(rs.NewResolverBuilder(map[string][]string{
		"cluster@callee": {
			"127.0.0.1:8009",
			"127.0.0.1:8010",
		},
	}))

	balancer.Register(bl.NewBalancerBuilder())

	conn, err := grpc.Dial("example:///cluster@callee",
		grpc.WithInsecure(),
		grpc.WithDefaultServiceConfig(
			`{"loadBalancingPolicy":"random_picker"}`,
		),
	)
	if err != nil {
		panic(err)
	}
	
  ....
}




ä½œè€…ï¼šå‡‰å‡‰çš„çŸ¥è¯†åº“
é“¾æ¥ï¼šhttps://juejin.cn/post/7251231773673406520
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
