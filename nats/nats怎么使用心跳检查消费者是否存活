NATS JetStream æœ¬èº«å¹¶ä¸æä¾›â€œå¿ƒè·³è§¦å‘é‡è¯•â€æœºåˆ¶ï¼Œå®ƒåªåŸºäºï¼š

AckWait è¶…æ—¶

å®¢æˆ·ç«¯æ–­çº¿

æ¶ˆè´¹è€…é‡è¿

NATS server å‘ç° consumer æ— å“åº”

ç„¶åè¿›è¡Œé‡æŠ•é€’ï¼ˆredeliverï¼‰ã€‚

ä¸è¿‡ä½ å¯ä»¥é€šè¿‡ JetStream æä¾›çš„ Flow Control + Heartbeatï¼ˆå¿ƒè·³ï¼‰æœºåˆ¶ æ¥æ£€æµ‹ consumer æ˜¯å¦å¡æ­»ï¼Œä»è€ŒåŠ é€Ÿè§¦å‘ redeliverã€‚ä½†è¦æ³¨æ„ï¼š

å¿ƒè·³ï¼ˆHeartbeatï¼‰æœ¬èº«ä¸ä¼šç›´æ¥è§¦å‘é‡è¯•ï¼Œåªä¼šè§¦å‘ consumer è¢«è®¤ä¸ºæ— å“åº”ï¼Œç„¶å JetStream ä¼šé‡æ–°åˆ†é…æ¶ˆæ¯ã€‚

ä¸‹é¢è¯¦ç»†è§£é‡ŠğŸ‘‡

âœ” 1. JetStream å¿ƒè·³ï¼ˆIdleHeartbeatï¼‰èƒ½åšä»€ä¹ˆï¼Ÿ

JetStream Push Consumer æ”¯æŒå¿ƒè·³ï¼š

nats.IdleHeartbeat(5 * time.Second)


ä½œç”¨æ˜¯ï¼š

NATS server ä¼šæ¯éš” N ç§’å‘ä¸€ä¸ªç©ºæ¶ˆæ¯ï¼ˆå¿ƒè·³ï¼‰ã€‚

å¦‚æœå®¢æˆ·ç«¯ N Ã— 2 æˆ–æ›´å¤š æ—¶é—´æœªå›åº”ï¼Œserver ä¼šè®¤ä¸º consumer æ­»äº¡ã€‚

è¿™æ · JetStream ä¼šè§¦å‘ï¼š

é‡æ–°å‘é€æŒ‚ä½çš„æœª ack æ¶ˆæ¯

è§¦å‘é‡å¹³è¡¡

æ–­å¼€æ— å“åº” consumer è¿æ¥

âœ” å¿ƒè·³æ˜¯ä¸ºäº†æ£€æµ‹ consumer æ˜¯å¦æŒ‚æ‰ï¼Œè€Œä¸æ˜¯æ£€æµ‹æ¶ˆæ¯æ˜¯å¦éœ€è¦é‡è¯•ã€‚

âœ” 2. Flow Controlï¼ˆæµæ§ï¼‰èƒ½æ£€æµ‹ consumer å¡æ­»

ä¸å¿ƒè·³ä¸€èµ·ä½¿ç”¨ï¼š

nats.EnableFlowControl()


æœåŠ¡å™¨ä¼šæŒ‰éœ€å‘é€ Flow Control æ¶ˆæ¯ã€‚

å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å›åº”ï¼š

JetStream ä¼šæ¨æ–­ consumer æ­»äº¡

server ä¼šæ–­å¼€ consumer

æœª ack çš„æ¶ˆæ¯ä¼šç«‹å³ redeliver

â­ æ‰€ä»¥â€œå¿ƒè·³ + æµæ§â€ç»„åˆå¯ä»¥å®ç°â€œå¡æ­»æœ€å¿«æ£€æµ‹â€ï¼Œé‡æ–°æŠ•é€’é€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸æ˜¯ç­‰å¾… AckWaitã€‚

âœ” 3. ä½ æƒ³è¦çš„â€œé€šè¿‡å¿ƒè·³åˆ¤æ–­æ˜¯å¦é‡è¯•â€å¯ä»¥åšåˆ°å—ï¼Ÿ

å¯ä»¥åšåˆ°ç±»ä¼¼æ•ˆæœï¼Œä½†ä¸æ˜¯ç›´æ¥æ„ä¹‰ä¸Šçš„â€œå¿ƒè·³è§¦å‘é‡è¯•â€ã€‚

ä½ å¯ä»¥é€šè¿‡ï¼š

âœ” æ–¹æ¡ˆ Aï¼šæŠŠ AckWait è®¾å¾—æ›´é•¿ï¼Œå¿ƒè·³ + æµæ§ä½œä¸ºæå‰é‡è¯•æœºåˆ¶
js.Subscribe("events", handler,
    nats.ManualAck(),
    nats.AckWait(30*time.Second),
    nats.IdleHeartbeat(5*time.Second),
    nats.EnableFlowControl(),
)


è¡Œä¸ºï¼š

AckWait = 30 ç§’

ä½†å¦‚æœ consumer 5 ç§’å¿ƒè·³å¤±è” â†’ JetStream ä¼šç«‹å³è§¦å‘é‡è¯•ï¼ˆæ–­å¼€ consumerï¼‰ã€‚

è¿™ç§æ–¹å¼æ¯”å•çº¯ç­‰ AckWait æ›´å¿«ã€‚

âœ” 4. Pull Consumer æ”¯æŒå¿ƒè·³å—ï¼Ÿ

ä¸æ”¯æŒ IdleHeartbeatã€‚

Pull æ¨¡å¼ä¸ä¼šä¸»åŠ¨æ¨æ¶ˆæ¯ï¼Œå› æ­¤æ²¡æœ‰å¿ƒè·³æ¦‚å¿µã€‚

å¦‚æœä½ è¦ Pull consumer çš„â€œå¿ƒè·³æ£€æµ‹â€ï¼Œä½ å¿…é¡»è‡ªå·±å®ç°ï¼š

for {
    msgs, err := sub.Fetch(10, nats.MaxWait(3*time.Second))
    if err == nats.ErrTimeout {
        // è¿™é‡Œå¯ä»¥è®¤ä¸º consumer æ­£å¸¸ç©ºé—²
    }
}


ä»–ä¸ä¼šè§¦å‘ JetStream é‡è¯•ï¼Œåªæ˜¯ä½ è‡ªå·±çš„æ¢æ´»ã€‚

JetStream å¿ƒè·³ï¼ˆIdleHeartbeat)çš„å…·ä½“ä»£ç ä¾‹å­
ä¸‹é¢ç»™ä½ ä¸€ä¸ª æœ€å°å¯è¿è¡Œï¼ˆå¯ç›´æ¥ copyï¼‰ çš„ JetStream IdleHeartbeat ç¤ºä¾‹ï¼Œå±•ç¤ºï¼š

å¦‚ä½•åˆ›å»º JetStream Push Consumer

å¦‚ä½•å¯ç”¨ IdleHeartbeat

å¦‚ä½•å¯ç”¨ FlowControl

å¦‚ä½•æ£€æµ‹å¿ƒè·³ä¸¢å¤±æˆ– consumer å¡æ­»

JetStream å¦‚ä½•è‡ªåŠ¨é‡è¯•ï¼ˆredeliverï¼‰

âœ” 1. å¯åŠ¨ JetStreamï¼ˆç¤ºä¾‹ï¼‰

ç¡®ä¿ NATS å¯åŠ¨ JetStreamï¼š

nats-server -js


åˆ›å»ºä¸€ä¸ª streamï¼š

nats stream add EVENTS --subjects "events.*"

âœ” 2. Go ä»£ç ç¤ºä¾‹ï¼ˆPush Consumer + IdleHeartbeat + FlowControlï¼‰

ä¸‹é¢å°±æ˜¯ä½ è¦çš„ å®˜æ–¹æ¨èç”¨æ³•ï¼š

package main

import (
	"fmt"
	"log"
	"time"

	"github.com/nats-io/nats.go"
)

func main() {
	nc, err := nats.Connect("nats://127.0.0.1:4222")
	if err != nil {
		log.Fatal(err)
	}

	js, err := nc.JetStream()
	if err != nil {
		log.Fatal(err)
	}

	// åˆ›å»º Push Consumerï¼Œå¼€å¯ å¿ƒè·³ + æµæ§
	sub, err := js.Subscribe("events.test",
		func(msg *nats.Msg) {
			fmt.Println("received:", string(msg.Data))

			// æ•…æ„ä¸ Ackï¼Œè®©ä½ èƒ½å¤Ÿçœ‹åˆ°é‡è¯•
			// msg.Ack()
		},
		nats.ManualAck(),
		nats.AckWait(20*time.Second),                 // æ­£å¸¸é‡è¯•æ—¶é—´
		nats.IdleHeartbeat(5*time.Second),            // å¿ƒè·³æ¢æµ‹
		nats.EnableFlowControl(),                     // å¿…é¡»é…åˆå¿ƒè·³ä½¿ç”¨
		nats.DeliverNew(),
	)
	if err != nil {
		log.Fatal(err)
	}

	fmt.Println("Consumer started, waiting messages ...")

	// å‘é€ä¸€æ¡æ¶ˆæ¯
	js.Publish("events.test", []byte("hello jetstream heartbeat test"))

	select {}
	_ = sub
}

âœ” 3. è¿™æ®µä»£ç çš„è¡Œä¸º

å¦‚æœ consumer æ­£å¸¸è¿è¡Œï¼š

received: hello jetstream heartbeat test


ä½†å¦‚æœ consumer å¡ä½æˆ–æŒ‚æ‰ï¼ˆä¾‹å¦‚ä¸šåŠ¡é€»è¾‘é˜»å¡ï¼‰ï¼š

JetStream æ¯ 5 ç§’ å‘é€ä¸€æ¬¡å¿ƒè·³

è‹¥å®¢æˆ·ç«¯ ä¸¢å¤±è¿ç»­å¤šä¸ªå¿ƒè·³
JetStream åˆ¤å®š consumer å·²æ­» â†’ å¼€å§‹ é‡æŠ•é€’ï¼ˆredeliverï¼‰

å³ä½¿ AckWait è®¾ç½® 20 ç§’ï¼ŒJetStream ä¹Ÿä¼šæå‰é‡æŠ•é€’ã€‚

âœ” 4. å¿ƒè·³ä¸¢å¤±æ£€æµ‹ç¤ºä¾‹

ä½ å¯ä»¥åœ¨å¤„ç†æ¶ˆæ¯æ—¶é˜»å¡ consumer æ¥è§‚å¯Ÿï¼š

// æ¨¡æ‹Ÿ consumer å¡ä½ 30 ç§’
time.Sleep(30 * time.Second)


ä½ ä¼šçœ‹åˆ° JetStream è‡ªåŠ¨é‡æŠ•é€’æ¶ˆæ¯ï¼š

received: hello jetstream heartbeat test
received: hello jetstream heartbeat test
...


JetStream åœ¨åå°åšçš„äº‹æƒ…ï¼š

IdleHeartbeat å‘ç° consumer æ— å“åº”

FlowControl è§¦å‘ consumer æ–­å¼€

æœª ACK æ¶ˆæ¯ç«‹åˆ» redeliver

ä¸ç­‰å¾… AckWait

è¿™å°±æ˜¯â€œæå‰é‡è¯•â€ã€‚

âœ” 5. Heartbeat æ¶ˆæ¯å¦‚ä½•è¢«å¤„ç†ï¼Ÿ

å¿ƒè·³æ¶ˆæ¯ç‰¹ç‚¹ï¼š

msg.Data ä¸ºç©º

msg.Subject æ˜¯åŸ subject

msg.Header.Get("Status") == "100 Heartbeat"

å¦‚æœä½ è¦æ‰‹å·¥å¤„ç†ï¼š

func handler(msg *nats.Msg) {
    if msg.Header.Get("Status") == "100 Heartbeat" {
        fmt.Println("ğŸ’“ heartbeat received")
        return
    }

    // æ­£å¸¸æ¶ˆæ¯
    fmt.Println("msg:", string(msg.Data))
}


ä½†ä¸€èˆ¬ä¸éœ€è¦æ‰‹å·¥å¤„ç†ï¼ŒJetStream è‡ªåŠ¨å¤„ç†ã€‚

âœ” æ€»ç»“ï¼ˆä½ éœ€è¦è®°ä½çš„ï¼‰
åŠŸèƒ½	æ˜¯å¦éœ€è¦
IdleHeartbeat	âœ” å¿…é¡»å¼€å¯ï¼Œå®šæœŸæ¢æ´»
FlowControl	âœ” å¿…é¡»æ­é…ï¼Œç¡®ä¿ consumer å¡æ­»æ—¶æ–­å¼€
AckWait	ä¸æ˜¯è§¦å‘æ—©æœŸé‡è¯•çš„å…³é”®ï¼Œä½†å¿…é¡»è®¾ç½®ä¸€ä¸ªè¾ƒå¤§å€¼
é‡è¯•è§¦å‘æ–¹å¼	å¿ƒè·³ä¸¢å¤± â†’ consumer è¢« JetStream æ ‡è®°æ­» â†’ ç«‹å³é‡è¯•

å¯ä»¥ï¼Œä½†è¡Œä¸ºä¸ä½ é¢„æœŸçš„ä¸ä¸€å®šç›¸åŒã€‚

ä¸‹é¢ç»™ä½ ä¸€ä¸ª æ˜ç¡®ã€å¯ä¾èµ–çš„è¯´æ˜ï¼š

âœ” æ˜¯å¦å¯ä»¥åªè®¾ç½® IdleHeartbeatï¼Œè€Œä¸è®¾ç½® AckWaitï¼Ÿ

å¯ä»¥ï¼ŒæŠ€æœ¯ä¸Šå®Œå…¨å…è®¸ï¼š

nats.IdleHeartbeat(5 * time.Second)


ä½ å¯ä»¥ omit æ‰ AckWaitï¼š

// ä¸è®¾ç½® AckWait
sub, _ := js.Subscribe("events.test",
    handler,
    nats.ManualAck(),
    nats.IdleHeartbeat(5*time.Second),
    nats.EnableFlowControl(),
)


ä»£ç èƒ½è·‘ï¼Œå¿ƒè·³èƒ½æ”¶åˆ°ï¼ŒFlowControl ä¹Ÿèƒ½å·¥ä½œã€‚

â—ï¸ ä½†é—®é¢˜æ˜¯ï¼šé‡æŠ•é€’è¡Œä¸ºä¼šå˜æˆâ€œé»˜è®¤ AckWait = 30 ç§’â€

JetStream ä¼šåœ¨ æ²¡æœ‰ AckWait çš„æƒ…å†µä¸‹è‡ªåŠ¨ä½¿ç”¨ é»˜è®¤å€¼ 30 ç§’ï¼š

AckWait = 30 seconds (é»˜è®¤)


æ‰€ä»¥æ¶ˆæ¯é‡è¯•ä¼šå—ä¸¤ä¸ªæœºåˆ¶å½±å“ï¼š

æœºåˆ¶	ä¼šè§¦å‘é‡è¯•	ä¸ AckWait å…³ç³»
AckWait è¶…æ—¶	âœ” è§¦å‘é‡æŠ•é€’	å—åˆ° AckWait æ§åˆ¶ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
IdleHeartbeat ä¸¢å¤±	âœ” å¯æå‰é‡æŠ•é€’	ä¸ AckWait æ— å…³
âœ” å¿ƒè·³ä¸¢å¤±ï¼ˆIdleHeartbeatï¼‰å¯ä»¥â€œæå‰é‡è¯•â€

å³ä½¿ AckWait ä¸ºé»˜è®¤çš„ 30 ç§’ï¼š

å¦‚æœ consumer å¡æ­» / é˜»å¡ / GC stop-the-world

JetStream ä¸¢å¤±ä¸€æ®µæ—¶é—´çš„å¿ƒè·³ï¼ˆæ¯”å¦‚ 2â€“3 ä¸ªå‘¨æœŸï¼‰

consumer ä¼šè¢« JetStream æ ‡è®°ä¸º stale

æ¶ˆæ¯ä¼šç«‹å³é‡æŠ•é€’ï¼Œä¸ä¼šç­‰ 30 ç§’

è¿™æ˜¯ Push Consumer çš„æœºåˆ¶ã€‚

å› æ­¤ï¼šä½ æ— éœ€è®¾ç½® AckWaitï¼Œä¹Ÿèƒ½è®©å¿ƒè·³æå‰è§¦å‘é‡è¯•ã€‚

âœ” æ‰€ä»¥åªè®¾ç½® IdleHeartbeat è¡Œä¸è¡Œï¼Ÿ

è¡Œï¼Œä½†è¦æ³¨æ„ä¸¤ç‚¹ï¼š

â‘  ä½ ä¼šå¾—åˆ°é»˜è®¤ AckWait = 30s

è¿™æ„å‘³ç€ï¼š

å¿ƒè·³ä¸¢å¤± â†’ ç«‹å³é‡è¯•

ä¸šåŠ¡é”™è¯¯ â†’ 30 ç§’åé‡è¯•ï¼ˆå› ä¸º AckWait è§¦å‘ï¼‰

å¦‚æœä½ æƒ³ä¸šåŠ¡é”™è¯¯ä¹Ÿâ€œç«‹å³é‡è¯•â€ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®å° AckWaitï¼š

nats.AckWait(2 * time.Second)

â‘¡ IdleHeartbeat å¿…é¡»æ­é… EnableFlowControl

å¦åˆ™ JetStream æ— æ³•æ­£ç¡®æ£€æµ‹ consumer åœæ»ã€‚

ä½ å¿…é¡»è¿™æ ·å†™ï¼š

nats.IdleHeartbeat(5*time.Second),
nats.EnableFlowControl(),

âœ” æ¨èé…ç½®ï¼ˆæœ€ä½³å®è·µï¼‰

å¦‚æœä½ æƒ³ä½¿ç”¨å¿ƒè·³æ¥æ£€æµ‹â€œå¡æ­»â€ï¼Œå¹¶ä¸”å¸Œæœ›ä¸šåŠ¡é”™è¯¯å¿«é€Ÿé‡è¯•ï¼š

nats.IdleHeartbeat(5 * time.Second),
nats.EnableFlowControl(),
nats.AckWait(10 * time.Second), // ä¸šåŠ¡é”™è¯¯ 10 ç§’åé‡è¯•


å¦‚æœä½ å®Œå…¨ä¸å…³å¿ƒä¸šåŠ¡é”™è¯¯é‡è¯•æ—¶é—´ï¼š

nats.IdleHeartbeat(5 * time.Second),
nats.EnableFlowControl(),       // è¶³å¤Ÿé‡æ–°æŠ•é€’ consumer å¡æ­»çš„æƒ…å†µ

âœ” æ€»ç»“
é…ç½®	æ˜¯å¦å¿…é¡»	ç”¨é€”
IdleHeartbeat	âœ” å¿…é¡»ï¼Œç”¨äºæ£€æµ‹ consumer æ˜¯å¦å¡æ­»	
EnableFlowControl	âœ” å¿…é¡»ï¼Œä¸å¿ƒè·³é…å¥—å¯ç”¨	
AckWait	å¯é€‰ï¼Œä¸è®¾ç½®å°±é»˜è®¤ 30 ç§’	

åªè®¾ç½® IdleHeartbeat æ˜¯å¯ä»¥çš„ï¼Œåªè¦ä½ çŸ¥é“ AckWait ä¼šé‡‡ç”¨é»˜è®¤çš„ 30 ç§’ï¼Œå¹¶ä¸”ä¸šåŠ¡é”™è¯¯ä¸ä¼šç«‹å³é‡è¯•ã€‚

EnableFlowControlå’ŒIdleHeartbeatçš„å…³ç³»
ä½ è¯´ï¼š
ä¸ºä»€ä¹ˆä¸¤è€…å¿…é¡»æ­é…ä½¿ç”¨
ä½ è¯´ï¼š
æ—¢ç„¶å¯ç”¨äº†EnableFlowControlå°±ä¼šæ£€æµ‹å®¢æˆ·ç«¯å¤„ç†èƒ½åŠ› ä¸ºä»€ä¹ˆè¿˜è¦IdleHeartbeat
