MongoDB å®˜æ–¹æ¨èçš„ æ— é”æ•°æ®æ›¿æ¢ï¼ˆatomic rename swapï¼‰ æ¨¡å¼ã€‚

ä½ å¯ä»¥ï¼š

åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸´æ—¶é›†åˆ

å†™å…¥å®Œæ•´çš„æ–°æ•°æ®

ä½¿ç”¨ renameCollection å°†ä¸´æ—¶é›†åˆåŸå­æ€§æ›¿æ¢æ—§é›†åˆ

ï¼ˆå¯é€‰ï¼‰åˆ é™¤ä¸´æ—¶é›†åˆ

è¿™å’Œæ•°æ®åº“ä¸­çš„ atomic table swap å¾ˆç±»ä¼¼ã€‚

âœ” è¦†ç›–æ—§é›†åˆçš„ rename æ“ä½œå†™æ³•

MongoDB æä¾› dropTarget: true å‚æ•°ï¼Œç”¨äº è¦†ç›–ç›®æ ‡é›†åˆã€‚

cmd := bson.D{
    {"renameCollection", "mydb.tmp_new_data"},
    {"to", "mydb.users"}, // è¦†ç›–æ—§çš„ users é›†åˆ
    {"dropTarget", true}, // è‡ªåŠ¨åˆ é™¤ mydb.users
}


è¿™æ˜¯ åŸå­æ“ä½œ â€”â€” è¦ä¹ˆå®Œå…¨æ›¿æ¢æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥ã€‚ä¸ä¼šå‡ºç°éƒ¨åˆ†å†™å…¥çŠ¶æ€ã€‚

âœ” ä¸ºä»€ä¹ˆè¿™ç§æ–¹å¼å®‰å…¨ï¼Ÿ
1. renameCollection æ˜¯ atomic

å®ƒä¸ä¼šå‡ºç° rename åˆ°ä¸€åŠå¤±è´¥çš„é—®é¢˜ã€‚

2. ä¸ä¼šé”æ•´åº“ï¼Œåªä¼šçŸ­æ—¶é—´é” old/new é›†åˆæ‰€åœ¨ namespace

å®˜æ–¹æ–‡æ¡£è¯´æ˜ rename æ“ä½œåœ¨ WiredTiger å¼•æ“ä¸­æ˜¯è½»é‡çº§çš„ã€‚

3. è¦†ç›–ï¼ˆdropTarget: trueï¼‰æ˜¯ä¸€æ¬¡æ€§åŠ¨ä½œ

ä¸ä¼šå‡ºç°å…ˆ drop å† rename å¯¼è‡´çŸ­æš‚æ²¡æœ‰é›†åˆçš„ windowã€‚

âœ” æ¨èæµç¨‹ï¼ˆå¯¹ç”Ÿäº§å‹å¥½ï¼‰
tmpName := "users_tmp_" + time.Now().Format("20060102150405")

// 1. å†™å…¥åˆ°ä¸´æ—¶é›†åˆ
tmpCol := client.Database("mydb").Collection(tmpName)
// ... æ‰¹é‡å†™å…¥æ–°æ•°æ® ...

// 2. rename è¦†ç›–
cmd := bson.D{
    {"renameCollection", "mydb." + tmpName},
    {"to", "mydb.users"}, 
    {"dropTarget", true},
}

adminDB := client.Database("admin")
if err := adminDB.RunCommand(ctx, cmd).Err(); err != nil {
    return err
}

// 3. å®Œæˆ - æ–°æ•°æ®å·²å®Œå…¨æ›¿æ¢æ—§æ•°æ®

âœ” æ³¨æ„äº‹é¡¹
1. renameCollection å¿…é¡»åœ¨ admin DB é‡Œæ‰§è¡Œ

å¦åˆ™ä¼šæŠ¥é”™ï¼š

Unauthorized: not authorized on mydb ...

2. æƒé™éœ€è¦ dbAdminAnyDatabase æˆ–æ›´é«˜
3. è·¨ DB rename å¯ä»¥

e.g.:

old_db.tmp_xxx â†’ new_db.target

4. éœ€è¦ç¡®ä¿ tmp collection åå”¯ä¸€

é¿å…å†²çªã€‚

âœ” ç”Ÿäº§å®æˆ˜ä¸­çš„ä¼˜é›…æ¨¡å¼
A. å…ˆå†™ä¸´æ—¶é›†åˆ
users_tmp_20251109

B. rename è¦†ç›–æ—§çš„ users
dropTarget: true

C. å®Œæˆåç«‹åˆ»åˆ é™¤æ—§ tmpï¼ˆå¯é€‰ï¼‰

å› ä¸º rename å·²ç»ç”¨æ‰ tmp åç§°äº†ï¼Œtmp é›†åˆå·²ç»æ¶ˆå¤±ã€‚

âœ” æ€»ç»“

ä½ è¯´çš„æ¨¡å¼ï¼š

å…ˆå†™å…¥æ–°é›†åˆ
rename è¦†ç›–æ—§é›†åˆ

æ˜¯ æœ€ä½³å®è·µ ğŸ‘

é€‚ç”¨äºï¼š

ç”¨æ–°æ•°æ®åŸå­è¦†ç›–æ—§å…¨é‡æ•°æ®

Schema å˜åŒ–

æ•°æ®å¯¼å…¥æ›¿æ¢

è“ç»¿åˆ‡æ¢
